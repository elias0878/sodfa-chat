<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0ea5e9" id="meta-theme-color">
    <meta name="description" content="صدفة - دردشة عشوائية مجهولة مع الغرباء">
    <title>صدفة - دردشة عشوائية</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Load MQTT Library first -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        /* ========== CSS Variables & Reset ========== */
        :root {
            /* Light Mode Colors */
            --primary-color: #0ea5e9;
            --primary-light: #38bdf8;
            --primary-dark: #0284c7;
            --secondary-color: #10b981;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --danger-light: #fecaca;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --self-bubble: linear-gradient(135deg, #0ea5e9, #06b6d4);
            --self-bubble-text: #ffffff;
            --partner-bubble: #f1f5f9;
            --partner-bubble-text: #334155;
            --border-color: #e2e8f0;
            --shadow-soft: 0 2px 8px rgba(14, 165, 233, 0.1);
            --shadow-medium: 0 4px 16px rgba(14, 165, 233, 0.15);
            --shadow-strong: 0 8px 32px rgba(14, 165, 233, 0.2);
            --radius-small: 12px;
            --radius-medium: 16px;
            --radius-large: 24px;
            --radius-pill: 50px;
            --header-height: 60px;
            --input-height: 70px;
            --footer-height: 55px;
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Dark Mode Colors */
        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --partner-bubble: #334155;
            --partner-bubble-text: #e2e8f0;
            --border-color: #334155;
            --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-strong: 0 8px 32px rgba(0, 0, 0, 0.5);
            --primary-color: #38bdf8;
            --primary-dark: #0ea5e9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        
        /* ========== App Container ========== */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            position: relative;
            overflow: hidden;
            transition: background-color var(--transition-normal);
        }
        
        /* ========== Header ========== */
        .header {
            background: var(--card-bg);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--header-height);
            min-height: var(--header-height);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            z-index: 1000;
            flex-shrink: 0;
            position: relative;
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            min-width: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            transition: all var(--transition-normal);
        }
        
        .status-dot.connected { 
            background: var(--success-color);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        .status-dot.searching { 
            background: var(--primary-color);
            animation: pulse 1s ease-in-out infinite;
        }
        
        .status-dot.error { background: var(--danger-color); }
        .status-dot.connecting { 
            background: var(--warning-color);
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }
        
        .header-right {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-icon:active {
            background: var(--bg-color);
            transform: scale(0.95);
        }
        
        .theme-toggle {
            position: relative;
        }
        
        .theme-toggle .sun-icon,
        .theme-toggle .moon-icon {
            position: absolute;
            transition: all var(--transition-normal);
        }
        
        [data-theme="dark"] .theme-toggle .sun-icon {
            opacity: 1;
            transform: scale(1);
        }
        
        [data-theme="dark"] .theme-toggle .moon-icon {
            opacity: 0;
            transform: scale(0.5);
        }
        
        [data-theme="light"] .theme-toggle .sun-icon {
            opacity: 0;
            transform: scale(0.5);
        }
        
        [data-theme="light"] .theme-toggle .moon-icon {
            opacity: 1;
            transform: scale(1);
        }
        
        .btn-next {
            background: var(--primary-color);
            color: white;
            padding: 8px 14px;
            min-height: 38px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-soft);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-next:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ========== Screens ========== */
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            height: calc(100% - var(--header-height));
        }
        
        .screen.active {
            display: flex;
            height: 100%;
        }
        
        /* ========== Welcome Screen ========== */
        .welcome-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
            overflow-y: auto;
            transition: background-color var(--transition-normal);
        }
        
        [data-theme="dark"] .welcome-screen {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }
        
        .welcome-card {
            background: var(--card-bg);
            padding: 40px 28px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 380px;
            width: 100%;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .welcome-logo {
            font-size: 64px;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .welcome-subtitle {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }
        
        .features-list {
            list-style: none;
            text-align: right;
            margin-bottom: 28px;
        }
        
        .features-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color var(--transition-normal);
        }
        
        .features-list li:last-child {
            border-bottom: none;
        }
        
        .features-list li::before {
            content: '✓';
            color: var(--success-color);
            font-weight: bold;
        }
        
        .btn-start {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 24px;
            cursor: pointer;
            width: 100%;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-start:active:not(:disabled) {
            transform: scale(0.97);
        }
        
        .btn-start:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ========== Connecting Screen with Text Slider ========== */
        .connecting-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
            position: relative;
            transition: background-color var(--transition-normal);
        }
        
        [data-theme="dark"] .connecting-screen {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }
        
        .connecting-card {
            background: var(--card-bg);
            padding: 48px 32px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .connecting-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
            transition: border-color var(--transition-normal);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .connecting-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .connecting-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .broker-name {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 11px;
            background: rgba(14, 165, 233, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: inline-block;
            word-break: break-all;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: background-color var(--transition-normal);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .retry-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .btn-cancel-connect {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .btn-cancel-connect::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .btn-cancel-connect:hover::before {
            opacity: 1;
        }
        
        .btn-cancel-connect:hover {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        .btn-cancel-connect:active {
            transform: scale(0.95);
        }
        
        .cancel-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            z-index: 4500;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .cancel-confirm-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .cancel-confirm-dialog {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 32px 24px;
            max-width: 340px;
            width: 100%;
            text-align: center;
            border: 2px solid var(--danger-color);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .cancel-confirm-overlay.active .cancel-confirm-dialog {
            transform: scale(1);
        }
        
        .cancel-confirm-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .cancel-confirm-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .cancel-confirm-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .cancel-confirm-actions {
            display: flex;
            gap: 12px;
        }
        
        .cancel-confirm-btn {
            flex: 1;
            padding: 14px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .cancel-confirm-btn.confirm {
            background: var(--danger-color);
            color: white;
            border: none;
        }
        
        .cancel-confirm-btn.confirm:active {
            transform: scale(0.95);
        }
        
        .cancel-confirm-btn.cancel {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }
        
        .cancel-confirm-btn.cancel:active {
            transform: scale(0.95);
        }
        
        /* ========== Text Slider ========== */
        .text-slider-container {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            transition: border-color var(--transition-normal);
        }
        
        .text-slider {
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slider-message {
            position: absolute;
            width: 100%;
            padding: 0 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.8s ease-in-out;
            pointer-events: none;
        }
        
        .slider-message.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .slider-message.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .slider-message .highlight {
            color: var(--primary-color);
            font-weight: 800;
        }
        
        /* ========== Chat Screen ========== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            overflow: hidden;
            height: 100%;
            padding-bottom: calc(var(--input-height) + var(--footer-height));
            transition: background-color var(--transition-normal);
        }
        
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            -webkit-overflow-scrolling: touch;
            background: var(--bg-color);
            transition: background-color var(--transition-normal);
        }
        
        .messages-area::-webkit-scrollbar {
            width: 4px;
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
            opacity: 0.5;
        }
        
        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 20px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .empty-state-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .empty-state-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .empty-state-stickers {
            display: flex;
            gap: 12px;
            font-size: 28px;
        }
        
        .empty-state-sticker {
            animation: pop 1s ease-in-out infinite;
            cursor: pointer;
            transition: transform var(--transition-fast);
        }
        
        .empty-state-sticker:active {
            transform: scale(1.3);
        }
        
        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .empty-state-sticker:nth-child(2) { animation-delay: 0.2s; }
        .empty-state-sticker:nth-child(3) { animation-delay: 0.4s; }
        
        /* Message Animations */
        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: var(--radius-large);
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            transition: transform 0.15s ease, background-color var(--transition-normal);
            box-shadow: var(--shadow-soft);
            cursor: pointer;
        }
        
        .message.sent {
            align-self: flex-end;
            background: var(--self-bubble);
            color: var(--self-bubble-text);
            border-bottom-left-radius: 4px;
            margin-left: 16px;
            animation: slideInUp 0.4s ease-out;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--partner-bubble);
            color: var(--partner-bubble-text);
            border-bottom-right-radius: 4px;
            margin-right: 16px;
            animation: slideInDown 0.4s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .message:active {
            transform: scale(0.98);
        }
        
        .message .meta {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .message-time {
            cursor: pointer;
            transition: opacity var(--transition-fast);
        }
        
        .message-time:hover {
            opacity: 1;
        }
        
        /* Reply Indicator */
        .reply-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        
        .reply-indicator:active {
            background: rgba(14, 165, 233, 0.2);
        }
        
        .reply-indicator-icon {
            font-size: 14px;
        }
        
        .reply-indicator-text {
            flex: 1;
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .reply-indicator-original {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Message Context Menu */
        .context-menu {
            display: none;
            position: fixed;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-strong);
            padding: 8px;
            z-index: 3000;
            min-width: 180px;
            border: 1px solid var(--border-color);
            animation: fadeInScale 0.2s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .context-menu.active {
            display: block;
        }
        
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: background var(--transition-fast);
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .context-menu-item:active {
            background: var(--bg-color);
        }
        
        .context-menu-item.danger {
            color: var(--danger-color);
        }
        
        .context-menu-item.danger:active {
            background: var(--danger-light);
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
            transition: background-color var(--transition-normal);
        }
        
        /* Message Types */
        .message.sticker {
            padding: 6px 10px;
            background: transparent !important;
            box-shadow: none !important;
        }
        
        .message.sticker.sent {
            align-self: flex-end;
            margin-left: 10%;
        }
        
        .message.sticker.received {
            align-self: flex-start;
            margin-right: 10%;
        }
        
        .message.sticker span {
            font-size: 48px;
            display: block;
            animation: stickerFly 0.4s ease-out;
        }
        
        @keyframes stickerFly {
            0% {
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }
            50% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0);
            }
        }
        
        .message.image {
            padding: 4px;
            background: transparent !important;
            box-shadow: none !important;
        }
        
        .message.image.sent {
            align-self: flex-end;
            margin-left: 10%;
        }
        
        .message.image.received {
            align-self: flex-start;
            margin-right: 10%;
        }
        
        .message-image {
            max-width: 100%;
            border-radius: 12px;
            cursor: pointer;
            display: block;
            animation: imageFadeIn 0.4s ease-out;
        }
        
        @keyframes imageFadeIn {
            from {
                opacity: 0;
                filter: blur(10px);
            }
            to {
                opacity: 1;
                filter: blur(0);
            }
        }
        
        .system-message {
            align-self: center;
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            text-align: center;
            max-width: 90%;
            font-weight: 600;
        }
        
        /* ========== Typing Indicator ========== */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 10px 14px;
            color: var(--text-secondary);
            font-size: 12px;
            margin: 0 0 8px 0;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 6px;
            vertical-align: middle;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        
        /* ========== Reply Bar ========== */
        .reply-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(14, 165, 233, 0.08);
            border-top: 1px solid var(--border-color);
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .reply-bar.active {
            display: flex;
        }
        
        .reply-bar-icon {
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .reply-bar-content {
            flex: 1;
            min-width: 0;
        }
        
        .reply-bar-original {
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .reply-bar-preview {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .reply-bar-cancel {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background var(--transition-fast);
        }
        
        .reply-bar-cancel:active {
            background: var(--danger-color);
            color: white;
        }
        
        /* ========== Stickers Panel ========== */
        .sticker-panel {
            display: none;
            position: fixed;
            bottom: calc(var(--input-height) + var(--footer-height) + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: var(--shadow-strong);
            padding: 16px;
            z-index: 999;
            border: 1px solid var(--border-color);
            width: calc(100% - 32px);
            max-width: 400px;
            box-sizing: border-box;
            animation: slideUp 0.3s ease-out;
        }
        
        [data-theme="dark"] .sticker-panel {
            background: rgba(30, 41, 59, 0.98);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .sticker-panel.active {
            display: block;
        }
        
        .sticker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-normal);
        }
        
        .sticker-header h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .sticker-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--bg-color);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .sticker-close:active {
            background: var(--danger-color);
            color: white;
        }
        
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
            padding: 4px;
        }
        
        .sticker-item {
            font-size: 28px;
            text-align: center;
            padding: 6px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.1s ease;
        }
        
        .sticker-item:active {
            transform: scale(0.85);
        }
        
        /* ========== Input Area ========== */
        .input-area {
            background: var(--card-bg);
            padding: 10px 14px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            min-height: var(--input-height);
            height: auto;
            box-sizing: border-box;
            position: absolute;
            bottom: var(--footer-height);
            left: 0;
            right: 0;
            z-index: 100;
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .input-actions {
            display: flex;
            gap: 4px;
        }
        
        .btn-action {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary-color);
            transition: all var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-action:active {
            background: rgba(14, 165, 233, 0.1);
            transform: scale(0.9);
        }
        
        .input-wrapper {
            flex: 1;
            background: var(--bg-color);
            border-radius: 24px;
            padding: 4px 4px 4px 16px;
            display: flex;
            align-items: center;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }
        
        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            background: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .input-wrapper textarea {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 15px;
            outline: none;
            color: var(--text-primary);
            padding: 8px 0;
            resize: none;
            max-height: 100px;
            line-height: 1.4;
            font-family: inherit;
        }
        
        .input-wrapper textarea::placeholder {
            color: var(--text-secondary);
        }
        
        .btn-send {
            width: 44px;
            height: 44px;
            min-width: 44px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-soft);
        }
        
        .btn-send:active:not(:disabled) {
            transform: scale(0.9);
        }
        
        .btn-send:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transition: background-color var(--transition-normal);
        }
        
        /* ========== Footer ========== */
        .footer {
            background: var(--card-bg);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-top: 1px solid var(--border-color);
            height: var(--footer-height);
            min-height: var(--footer-height);
            flex-shrink: 0;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99;
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .footer-text {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .footer-link {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-decoration: none;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-soft);
        }
        
        .footer-link:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .footer-link:active {
            transform: scale(0.95);
        }
        
        .footer-icon {
            font-size: 14px;
        }
        
        /* ========== Disconnected Screen ========== */
        .disconnected-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
            transition: background-color var(--transition-normal);
        }
        
        [data-theme="dark"] .disconnected-screen {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }
        
        .disconnected-card {
            background: var(--card-bg);
            padding: 48px 28px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 380px;
            width: 100%;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .disconnected-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .disconnected-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .disconnected-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 28px;
        }
        
        .btn-reconnect {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 700;
            border-radius: 24px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-reconnect:active {
            transform: scale(0.97);
        }
        
        .btn-home {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            padding: 12px 28px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }
        
        .btn-home:active {
            transform: scale(0.97);
        }
        
        /* ========== Error Screen ========== */
        .error-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
            transition: background-color var(--transition-normal);
        }
        
        [data-theme="dark"] .error-screen {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }
        
        .error-card {
            background: var(--card-bg);
            padding: 44px 28px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--danger-color);
        }
        
        .error-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .error-details {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 12px;
            font-size: 10px;
            font-family: monospace;
            text-align: right;
            margin: 16px 0;
            max-height: 80px;
            overflow-y: auto;
            word-break: break-all;
            transition: background-color var(--transition-normal);
        }
        
        .btn-retry {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 700;
            border-radius: 24px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-retry:active {
            transform: scale(0.97);
        }
        
        /* ========== Settings Modal ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 24px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            border: 1px solid var(--border-color);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease, background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-normal);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .modal-close:active {
            background: var(--danger-color);
            color: white;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .settings-section {
            margin-bottom: 28px;
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
        }
        
        .settings-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-list {
            list-style: none;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--bg-color);
            border-radius: 14px;
            margin-bottom: 10px;
            transition: all var(--transition-fast);
        }
        
        .settings-item:last-child {
            margin-bottom: 0;
        }
        
        .settings-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .settings-item-icon {
            font-size: 20px;
        }
        
        .settings-item-text {
            flex: 1;
        }
        
        .settings-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .settings-item-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: all var(--transition-fast);
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: all var(--transition-fast);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Slider Input */
        .slider-input-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .slider-input {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            outline: none;
        }
        
        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            transition: transform var(--transition-fast);
        }
        
        .slider-input::-webkit-slider-thumb:active {
            transform: scale(1.1);
        }
        
        .slider-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            min-width: 45px;
            text-align: left;
        }
        
        .cta-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-medium);
        }
        
        .cta-button:active {
            transform: scale(0.97);
        }
        
        .modal-footer {
            padding: 16px 24px 20px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            transition: border-color var(--transition-normal);
        }
        
        .modal-footer-text {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .modal-footer-link {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }
        
        .modal-footer-link:active {
            text-decoration: underline;
        }
        
        /* ========== About Modal ========== */
        .about-section {
            margin-bottom: 28px;
        }
        
        .about-section:last-child {
            margin-bottom: 0;
        }
        
        .about-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .about-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.8;
        }
        
        .services-list {
            list-style: none;
        }
        
        .service-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: var(--bg-color);
            border-radius: 14px;
            margin-bottom: 10px;
            transition: all var(--transition-fast);
        }
        
        .service-item:last-child {
            margin-bottom: 0;
        }
        
        .service-item:active {
            transform: scale(0.98);
            background: rgba(14, 165, 233, 0.08);
        }
        
        .service-icon {
            font-size: 22px;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 10px;
        }
        
        .service-info {
            flex: 1;
        }
        
        .service-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .service-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* ========== Toast Notifications ========== */
        .toast {
            position: fixed;
            bottom: calc(var(--input-height) + var(--footer-height) + 60px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow-strong);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 3000;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
            visibility: visible;
        }
        
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.warning { background: var(--warning-color); }
        .toast.info { background: var(--primary-color); }
        
        /* ========== Image Viewer ========== */
        .image-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .image-viewer.active {
            display: flex;
        }
        
        .image-viewer img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 12px;
        }
        
        .image-viewer-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ========== Hidden Inputs ========== */
        .hidden-input {
            display: none;
        }
        
        /* ========== Debug Panel ========== */
        .debug-panel {
            display: none;
            position: fixed;
            top: calc(var(--header-height) + 10px);
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 12px;
            font-size: 10px;
            color: #00ff88;
            max-width: 260px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 999;
            font-family: monospace;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-title {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 11px;
        }
        
        .debug-line {
            margin: 2px 0;
            word-break: break-all;
        }
        
        .debug-timestamp {
            color: #888;
        }
        
        /* ========== Responsive Design ========== */
        @media (max-width: 400px) {
            .header {
                padding: 0 10px;
            }
            
            .app-title {
                font-size: 16px;
            }
            
            .status-indicator {
                display: none;
            }
            
            .btn-next {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .btn-icon {
                width: 34px;
                height: 34px;
                min-width: 34px;
                font-size: 14px;
            }
            
            .message {
                max-width: 82%;
                font-size: 14px;
                padding: 10px 14px;
            }
            
            .sticker-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .sticker-item {
                font-size: 24px;
                padding: 4px;
            }
            
            .message.sticker span {
                font-size: 40px;
            }
            
            .slider-message {
                font-size: 13px;
            }
            
            .empty-state-icon {
                font-size: 56px;
            }
            
            .empty-state-stickers {
                font-size: 24px;
            }
        }
        
        /* Tablet Breakpoint */
        @media (min-width: 768px) and (max-width: 1199px) {
            .app-container {
                max-width: 600px;
            }
            
            .welcome-card,
            .connecting-card,
            .disconnected-card,
            .error-card {
                max-width: 450px;
                padding: 48px 36px;
            }
            
            .message {
                max-width: 60%;
            }
            
            .sticker-grid {
                grid-template-columns: repeat(8, 1fr);
            }
            
            .modal-content {
                max-width: 480px;
            }
        }
        
        /* Desktop Breakpoint */
        @media (min-width: 1200px) {
            .app-container {
                max-width: 700px;
                margin: 20px auto;
                height: calc(100vh - 40px);
                height: calc(100dvh - 40px);
                border-radius: 24px;
                box-shadow: var(--shadow-strong);
            }
            
            .welcome-card,
            .connecting-card,
            .disconnected-card,
            .error-card {
                max-width: 420px;
            }
            
            .message {
                max-width: 55%;
            }
            
            .sticker-grid {
                grid-template-columns: repeat(8, 1fr);
            }
            
            /* Side panel for desktop */
            .app-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: -200px;
                width: 200px;
                height: 100%;
                background: linear-gradient(180deg, #f0f9ff 0%, transparent 100%);
                border-radius: 24px 0 0 24px;
            }
            
            [data-theme="dark"] .app-container::before {
                background: linear-gradient(180deg, #0f172a 0%, transparent 100%);
            }
        }
        
        /* Landscape Mode */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                height: 50px;
                min-height: 50px;
            }
            
            .input-area {
                height: 60px;
                min-height: 60px;
            }
            
            .welcome-logo {
                font-size: 48px;
            }
            
            .welcome-title {
                font-size: 24px;
            }
            
            .connecting-card {
                padding: 24px;
            }
            
            .text-slider-container {
                margin-top: 16px;
                padding-top: 16px;
            }
            
            .text-slider {
                min-height: 50px;
            }
        }
        
        /* Safe Area for Notched Phones */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .input-area {
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
            
            .footer {
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
            }
            
            .toast {
                bottom: calc(var(--input-height) + var(--footer-height) + 10px + env(safe-area-inset-bottom));
            }
            
            .sticker-panel {
                bottom: calc(var(--input-height) + var(--footer-height) + 10px + env(safe-area-inset-bottom));
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --text-secondary: #4a5568;
            }
            
            [data-theme="dark"] {
                --text-secondary: #cbd5e1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span class="app-title">صدفة</span>
                <div class="status-indicator">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="status-text">غير متصل</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn-icon theme-toggle" onclick="toggleTheme()" title="تبديل الثيم">
                    <span class="sun-icon">☀️</span>
                    <span class="moon-icon">🌙</span>
                </button>
                <button class="btn-icon" onclick="openAboutModal()" title="معلومات">ℹ️</button>
                <button class="btn-icon" onclick="toggleSettings()" title="الإعدادات">⚙️</button>
                <button class="btn-next" id="next-btn" onclick="findNewPartner()" disabled>
                    <span>🎲</span>
                    <span>شخص آخر</span>
                </button>
            </div>
        </header>
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <div class="welcome-screen">
                <div class="welcome-card">
                    <div class="welcome-logo">💬</div>
                    <h1 class="welcome-title">صدفة</h1>
                    <p class="welcome-subtitle">دردشة عشوائية مجهولة مع الغرباء</p>
                    <ul class="features-list">
                        <li>محادثة خاصة ومجهولة تماماً</li>
                        <li>إرسال صور وملصقات بسهولة</li>
                        <li>نظام مطابقة ذكي وموثوق</li>
                        <li>بدون تسجيل أو تحميل تطبيقات</li>
                    </ul>
                    <button class="btn-start" id="start-btn" onclick="startChat()">
                        <span>ابدأ الدردشة الآن</span>
                        <span>🚀</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Connecting Screen -->
        <div id="connecting-screen" class="screen">
            <div class="connecting-screen">
                <div class="connecting-card">
                    <div class="connecting-spinner"></div>
                    <h2 class="connecting-title" id="connecting-title">جاري البحث عن شريك...</h2>
                    <p class="connecting-desc" id="connecting-desc">قد يستغرق بعض الوقت حسب عدد المستخدمين المتاحين</p>
                    <div class="broker-name" id="broker-name">---</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="connection-progress"></div>
                    </div>
                    <p class="retry-count" id="retry-count"></p>
                    <button class="btn-cancel-connect" id="cancel-btn" onclick="handleCancelClick()">إلغاء</button>
                    
                    <!-- Cancel Confirmation Dialog -->
                    <div class="cancel-confirm-overlay" id="cancel-confirm" onclick="closeCancelConfirm()">
                        <div class="cancel-confirm-dialog" onclick="event.stopPropagation()">
                            <div class="cancel-confirm-icon">😕</div>
                            <h3 class="cancel-confirm-title">هل أنت متأكد؟</h3>
                            <p class="cancel-confirm-desc">لقد انتظرت لحظة... هل تريد حقاً إلغاء البحث؟</p>
                            <div class="cancel-confirm-actions">
                                <button class="cancel-confirm-btn cancel" onclick="closeCancelConfirm()">متابعة البحث</button>
                                <button class="cancel-confirm-btn confirm" onclick="cancelConnection()">نعم، إلغاء</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Text Slider -->
                    <div class="text-slider-container">
                        <div class="text-slider" id="text-slider">
                            <div class="slider-message" data-index="0">
                                <span class="highlight">فريق أبو نواف</span> هنا لاستعادة حسابك المسروق
                            </div>
                            <div class="slider-message" data-index="1">
                                حسابك <span class="highlight">مغلق أو معطل</span>؟ نحن الحل
                            </div>
                            <div class="slider-message" data-index="2">
                                تتعرض للابتزاز؟ تواصل مع <span class="highlight">فريق أبو نواف</span> بسرية
                            </div>
                            <div class="slider-message" data-index="3">
                                نسيت كلمة المرور؟ <span class="highlight">فريق أبو نواف</span>帮助你
                            </div>
                            <div class="slider-message" data-index="4">
                                تحتاج لفحص أمانك؟ <span class="highlight">هكر أخلاقي</span> خبير
                            </div>
                            <div class="slider-message" data-index="5">
                                <span class="highlight">فريق أبو نواف</span> - خدمات تقنية متكاملة
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Screen -->
        <div id="chat-screen" class="screen">
            <div class="chat-container">
                <!-- Empty State -->
                <div class="empty-state" id="empty-state">
                    <div class="empty-state-icon">💬</div>
                    <h3 class="empty-state-title">ابدأ المحادثة الآن!</h3>
                    <p class="empty-state-desc">أنت على وشك الحديث مع شخص غريب...</p>
                    <div class="empty-state-stickers">
                        <span class="empty-state-sticker" onclick="sendQuickSticker('👋')">👋</span>
                        <span class="empty-state-sticker" onclick="sendQuickSticker('😊')">😊</span>
                        <span class="empty-state-sticker" onclick="sendQuickSticker('🔥')">🔥</span>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="messages-area" id="messages-area"></div>
                <div class="typing-indicator" id="typing-indicator">
                    <span class="typing-dots"><span></span><span></span><span></span></span>
                    جاري الكتابة...
                </div>
                
                <!-- Reply Bar -->
                <div class="reply-bar" id="reply-bar">
                    <span class="reply-bar-icon">↩️</span>
                    <div class="reply-bar-content">
                        <div class="reply-bar-original">رد على:</div>
                        <div class="reply-bar-preview" id="reply-preview">---</div>
                    </div>
                    <button class="reply-bar-cancel" onclick="cancelReply()">✕</button>
                </div>
                
                <!-- Sticker Panel -->
                <div class="sticker-panel" id="sticker-panel">
                    <div class="sticker-header">
                        <h4>ملصقات</h4>
                        <button class="sticker-close" onclick="toggleStickers()">✕</button>
                    </div>
                    <div class="sticker-grid" id="sticker-grid"></div>
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-actions">
                        <button class="btn-action" onclick="toggleStickers()" title="ملصقات">😊</button>
                        <button class="btn-action" onclick="triggerImageUpload()" title="صورة">📷</button>
                    </div>
                    <div class="input-wrapper">
                        <textarea id="message-input" rows="1" placeholder="اكتب رسالتك..." onkeypress="handleEnter(event)" oninput="autoResize(this)" disabled></textarea>
                    </div>
                    <button class="btn-send" id="send-btn" onclick="sendMessage()" disabled>✈️</button>
                </div>
            </div>
        </div>
        
        <!-- Disconnected Screen -->
        <div id="disconnected-screen" class="screen">
            <div class="disconnected-screen">
                <div class="disconnected-card">
                    <div class="disconnected-icon">👋</div>
                    <h2 class="disconnected-title" id="disconnect-title">غادر الشخص المحادثة</h2>
                    <p class="disconnected-desc" id="disconnect-desc">هل تريد التحدث مع شخص آخر؟</p>
                    <button class="btn-reconnect" onclick="findNewPartner()">
                        <span>بحث عن شخص جديد</span>
                        <span>🔍</span>
                    </button>
                    <button class="btn-home" onclick="goHome()">
                        <span>العودة للرئيسية</span>
                        <span>🏠</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Error Screen -->
        <div id="error-screen" class="screen">
            <div class="error-screen">
                <div class="error-card">
                    <div class="error-icon">⚠️</div>
                    <h2 class="error-title" id="error-title">خطأ في الاتصال</h2>
                    <p class="error-desc" id="error-desc">حدث خطأ أثناء محاولة الاتصال</p>
                    <div class="error-details" id="error-details"></div>
                    <button class="btn-retry" onclick="retryConnection()">
                        <span>إعادة المحاولة</span>
                        <span>🔄</span>
                    </button>
                    <button class="btn-home" onclick="goHome()">
                        <span>العودة للرئيسية</span>
                        <span>🏠</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer" id="app-footer">
            <span class="footer-text">تم التطوير والحماية بواسطة </span>
            <a href="https://elias0878.github.io/accounts/" target="_blank" class="footer-link">
                <span class="footer-icon">🛡️</span>
                <span>فريق أبو نواف</span> 🇸🇦
            </a>
        </footer>
        
        <!-- Settings Modal -->
        <div class="modal-overlay" id="settings-modal" onclick="closeSettings(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <span>⚙️</span>
                        <span>الإعدادات</span>
                    </h3>
                    <button class="modal-close" onclick="closeSettings()">✕</button>
                </div>
                <div class="modal-body">
                    <div class="settings-section">
                        <h4 class="settings-title">
                            <span>🎨</span>
                            <span>المظهر</span>
                        </h4>
                        <ul class="settings-list">
                            <li class="settings-item">
                                <div class="settings-item-info">
                                    <span class="settings-item-icon">🌙</span>
                                    <div class="settings-item-text">
                                        <div class="settings-item-name">الوضع الداكن</div>
                                        <div class="settings-item-desc">تغيير الألوان للوضع الليلي</div>
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="theme-toggle" onchange="saveThemeSetting(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="settings-section">
                        <h4 class="settings-title">
                            <span>🔔</span>
                            <span>الإشعارات والصوت</span>
                        </h4>
                        <ul class="settings-list">
                            <li class="settings-item">
                                <div class="settings-item-info">
                                    <span class="settings-item-icon">🔊</span>
                                    <div class="settings-item-text">
                                        <div class="settings-item-name">تشغيل الصوت</div>
                                        <div class="settings-item-desc">أصوات عند إرسال واستقبال الرسائل</div>
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sound-toggle" checked onchange="saveSoundSetting(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </li>
                            <li class="settings-item">
                                <div class="settings-item-info">
                                    <span class="settings-item-icon">📳</span>
                                    <div class="settings-item-text">
                                        <div class="settings-item-name">الاهتزاز</div>
                                        <div class="settings-item-desc">تغذية راجعة لمسية عند التفاعل</div>
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="haptic-toggle" checked onchange="saveHapticSetting(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </li>
                            <li class="settings-item">
                                <div class="settings-item-info">
                                    <span class="settings-item-icon">🖼️</span>
                                    <div class="settings-item-text">
                                        <div class="settings-item-name">إرسال الصور تلقائياً</div>
                                        <div class="settings-item-desc">ضغط الصور قبل الإرسال</div>
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-image-toggle" checked onchange="saveAutoImageSetting(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="settings-section">
                        <h4 class="settings-title">
                            <span>⏱️</span>
                            <span>مهلة البحث</span>
                        </h4>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">⏰</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-name">مدة الانتظار قبل الإلغاء</div>
                                    <div class="settings-item-desc">ثوانٍ قبل إظهار رسالة عدم توفر مستخدمين</div>
                                </div>
                            </div>
                            <div class="slider-input-container">
                                <input type="range" class="slider-input" id="timeout-slider" min="10" max="60" value="15" onchange="saveTimeoutSetting(this.value)">
                                <span class="slider-value" id="timeout-value">15ث</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="cta-button" style="background: var(--danger-color);" onclick="confirmClearMessages()">
                        <span>🗑️</span>
                        <span>حذف جميع الرسائل</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- About Modal -->
        <div class="modal-overlay" id="about-modal" onclick="closeAboutModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <span>💬</span>
                        <span>عن صدفة</span>
                    </h3>
                    <button class="modal-close" onclick="closeAboutModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div class="about-section">
                        <h4 class="about-title">
                            <span>ℹ️</span>
                            <span>منصة صدفة</span>
                        </h4>
                        <p class="about-text">
                            صدفة هي منصة دردشة فورية آمنة، تمنحك حرية التواصل بخصوصية تامة وبدون تسجيل. نضمن لك بيئة محمية وتقنيات تشفير متقدمة.
                        </p>
                    </div>
                    
                    <div class="about-section">
                        <h4 class="about-title">
                            <span>🛡️</span>
                            <span>خدمات فريق أبو نواف</span>
                        </h4>
                        <ul class="services-list">
                            <li class="service-item">
                                <div class="service-icon">🔐</div>
                                <div class="service-info">
                                    <div class="service-name">استعادة الحسابات</div>
                                    <div class="service-desc">سناب، انستقرام، تويتر وحل مشاكل الإغلاق</div>
                                </div>
                            </li>
                            <li class="service-item">
                                <div class="service-icon">🛡️</div>
                                <div class="service-info">
                                    <div class="service-name">الأمن السيبراني</div>
                                    <div class="service-desc">الحماية من الابتزاز والاختراق</div>
                                </div>
                            </li>
                            <li class="service-item">
                                <div class="service-icon">💻</div>
                                <div class="service-info">
                                    <div class="service-name">البرمجيات والاستشارات</div>
                                    <div class="service-desc">برمجيات خاصة واستشارات تقنية متكاملة</div>
                                </div>
                            </li>
                        </ul>
                        <button class="cta-button" onclick="window.open('https://elias0878.github.io/accounts/', '_blank')">
                            <span>📞</span>
                            <span>تواصل معنا / طلب خدمة</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <p class="modal-footer-text">
                        تم التطوير والحماية بواسطة 
                        <a href="https://elias0878.github.io/accounts/" target="_blank" class="modal-footer-link">فريق أبو نواف</a>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Context Menu -->
        <div class="context-menu" id="context-menu">
            <div class="context-menu-item" onclick="copyMessage()">
                <span>📋</span>
                <span>نسخ النص</span>
            </div>
            <div class="context-menu-item" onclick="replyToMessage()">
                <span>↩️</span>
                <span>رد على الرسالة</span>
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" onclick="deleteMessage()">
                <span>🗑️</span>
                <span>حذف الرسالة</span>
            </div>
        </div>
        
        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>
        
        <!-- Image Viewer -->
        <div class="image-viewer" id="image-viewer" onclick="closeImageViewer()">
            <button class="image-viewer-close" onclick="closeImageViewer()">✕</button>
            <img id="viewer-image" src="" alt="صورة مكبرة">
        </div>
        
        <!-- Hidden Inputs -->
        <input type="file" id="image-input" class="hidden-input" accept="image/*" onchange="handleImageUpload(event)">
        
        <!-- Debug Panel -->
        <div class="debug-panel" id="debug-panel">
            <div class="debug-title">🔧 لوحة التصحيح</div>
            <div id="debug-content"></div>
        </div>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            BROKERS: [
                { url: 'wss://broker.emqx.io:8084/mqtt', name: 'EMQX (Primary)' },
                { url: 'wss://broker.hivemq.com:8000/mqtt', name: 'HiveMQ' },
                { url: 'wss://test.mosquitto.org:8081', name: 'Mosquitto Test' },
                { url: 'wss://mqtt.eclipseprojects.io:443/mqtt', name: 'Eclipse' }
            ],
            APP_PREFIX: 'sodfa_v5_',
            HELLO_INTERVAL: 2000,
            HANDSHAKE_TIMEOUT: 8000,
            CONNECTION_TIMEOUT: 15000,
            MAX_MESSAGE_AGE: 50,
            MAX_IMAGE_SIZE: 800,
            IMAGE_QUALITY: 0.7,
            MAX_PAYLOAD_SIZE: 100000,
            MAX_RETRIES: 3,
            CANCEL_WAIT_THRESHOLD: 8000 // 8 seconds before showing confirmation
        };
        
        // ========== STICKERS ==========
        const STICKERS = [
            '👋', '🤝', '👍', '👎', '❤️', '🧡', '💛', '💚', '💙', '💜',
            '🖤', '🤍', '🤎', '💔', '💕', '💞', '💓', '💗', '💖', '💘',
            '💝', '💟', '❣️', '💌', '💋', '💬', '💭', '💤', '💢', '💥',
            '😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '😊',
            '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😙', '😋', '😛',
            '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨',
            '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔',
            '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵',
            '🥶', '🥴', '😵', '🤯', '🤠', '🥳', '😎', '🤓', '🧐', '😕',
            '😮', '😯', '😲', '😳', '🥺', '😦', '😧', '😨', '😰', '😥',
            '😢', '😭', '😱', '😖', '😣', '😞', '😓', '😩', '😫', '🥱',
            '👶', '👧', '🧒', '👦', '👩', '🧑', '👨', '👵', '🧓', '👴',
            '🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯',
            '🦁', '🐮', '🐷', '🐸', '🐵', '🐔', '🐧', '🐦', '🐤', '🦆',
            '⭐', '🌟', '✨', '💫', '🌙', '☀️', '🌈', '⚡', '🎉', '🎊',
            '🎵', '🎶', '🎤', '🎧', '🍕', '🍔', '🍟', '📱', '💻', '✅'
        ];
        
        // ========== SOUND EFFECTS ==========
        const SOUNDS = {
            sent: null,
            received: null,
            connect: null,
            disconnect: null
        };
        
        // Create audio context for sound effects
        function initSounds() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioCtx = new AudioContext();
                
                // Create simple notification sound
                SOUNDS.sent = createOscillatorSound(audioCtx, 600, 100, 'sine');
                SOUNDS.received = createOscillatorSound(audioCtx, 800, 150, 'sine');
                SOUNDS.connect = createOscillatorSound(audioCtx, 400, 200, 'triangle');
                SOUNDS.disconnect = createOscillatorSound(audioCtx, 300, 300, 'sawtooth');
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        function createOscillatorSound(audioCtx, frequency, duration, type) {
            return () => {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration / 1000);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration / 1000);
            };
        }
        
        function playSound(soundName) {
            const settings = loadSettings();
            if (settings.sound && SOUNDS[soundName]) {
                SOUNDS[soundName]();
            }
        }
        
        // ========== HAPTIC FEEDBACK ==========
        function hapticFeedback(type = 'light') {
            const settings = loadSettings();
            if (!settings.haptic) return;
            
            if ('vibrate' in navigator) {
                switch (type) {
                    case 'light':
                        navigator.vibrate(5);
                        break;
                    case 'medium':
                        navigator.vibrate(50);
                        break;
                    case 'heavy':
                        navigator.vibrate([50, 50, 50]);
                        break;
                    case 'success':
                        navigator.vibrate([30, 50, 30]);
                        break;
                    case 'error':
                        navigator.vibrate([100, 50, 100]);
                        break;
                }
            }
        }
        
        // ========== STATE MANAGEMENT ==========
        const STATES = {
            IDLE: 'IDLE',
            CONNECTING: 'CONNECTING',
            SEARCHING: 'SEARCHING',
            NEGOTIATING: 'NEGOTIATING',
            CONNECTED: 'CONNECTED',
            ERROR: 'ERROR'
        };
        
        class AppState {
            constructor() {
                this.state = STATES.IDLE;
                this.myId = this.generateUUID();
                this.client = null;
                this.currentBroker = null;
                this.brokerIndex = 0;
                this.retryCount = 0;
                this.partnerId = null;
                this.roomId = null;
                this.helloIntervalId = null;
                this.handshakeTimeoutId = null;
                this.connectionTimeoutId = null;
                this.progressIntervalId = null;
                this.typingTimeoutId = null;
                this.partnerTyping = false;
                this.isTyping = false;
                this.subscriptions = new Set();
                this.messageCount = 0;
                this.isIntentionallyClosing = false;
                this.lastError = null;
                this.sliderIntervalId = null;
                this.cancelTimerId = null;
                this.searchStartTime = null;
                this.replyToMessage = null;
                this.selectedMessage = null;
                this.messages = [];
            }
            
            generateUUID() {
                return 'xxxx-xxxx-xxxx-xxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                }) + '-' + Date.now().toString(36);
            }
            
            get isSearching() { return this.state === STATES.SEARCHING; }
            get isNegotiating() { return this.state === STATES.NEGOTIATING; }
            get isConnected() { return this.state === STATES.CONNECTED; }
            get isIdle() { return this.state === STATES.IDLE; }
            get isConnecting() { return this.state === STATES.CONNECTING; }
            
            reset() {
                this.cleanup();
                this.state = STATES.IDLE;
                this.partnerId = null;
                this.roomId = null;
                this.partnerTyping = false;
                this.isTyping = false;
                this.messageCount = 0;
                this.brokerIndex = 0;
                this.retryCount = 0;
                this.replyToMessage = null;
                this.selectedMessage = null;
            }
            
            cleanup() {
                const ids = ['helloIntervalId', 'handshakeTimeoutId', 'connectionTimeoutId', 'progressIntervalId', 'typingTimeoutId', 'cancelTimerId'];
                ids.forEach(id => {
                    if (this[id]) {
                        clearTimeout(this[id]);
                        clearInterval(this[id]);
                        this[id] = null;
                    }
                });
                
                if (this.sliderIntervalId) {
                    clearInterval(this.sliderIntervalId);
                    this.sliderIntervalId = null;
                }
                
                if (this.client && this.client.connected) {
                    this.isIntentionallyClosing = true;
                    try {
                        this.client.end(false, () => {
                            console.log('[MQTT] Connection closed gracefully');
                        });
                    } catch(e) {}
                    this.isIntentionallyClosing = false;
                }
                this.client = null;
                this.subscriptions.clear();
            }
        }
        
        const app = new AppState();
        
        // ========== SETTINGS MANAGEMENT ==========
        function loadSettings() {
            const defaults = {
                theme: 'light',
                sound: true,
                haptic: true,
                autoImage: true,
                timeout: 15
            };
            
            try {
                const saved = localStorage.getItem('sodfa_settings');
                if (saved) {
                    return { ...defaults, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.log('Error loading settings');
            }
            return defaults;
        }
        
        function saveSettings(settings) {
            try {
                localStorage.setItem('sodfa_settings', JSON.stringify(settings));
            } catch (e) {
                console.log('Error saving settings');
            }
        }
        
        function saveThemeSetting(value) {
            const settings = loadSettings();
            settings.theme = value ? 'dark' : 'light';
            saveSettings(settings);
            applyTheme();
        }
        
        function saveSoundSetting(value) {
            const settings = loadSettings();
            settings.sound = value;
            saveSettings(settings);
        }
        
        function saveHapticSetting(value) {
            const settings = loadSettings();
            settings.haptic = value;
            saveSettings(settings);
        }
        
        function saveAutoImageSetting(value) {
            const settings = loadSettings();
            settings.autoImage = value;
            saveSettings(settings);
        }
        
        function saveTimeoutSetting(value) {
            const settings = loadSettings();
            settings.timeout = parseInt(value);
            saveSettings(settings);
            document.getElementById('timeout-value').textContent = value + 'ث';
        }
        
        function applyTheme() {
            const settings = loadSettings();
            document.documentElement.setAttribute('data-theme', settings.theme);
            document.getElementById('theme-toggle').checked = settings.theme === 'dark';
            document.getElementById('meta-theme-color').content = settings.theme === 'dark' ? '#1e293b' : '#0ea5e9';
        }
        
        function toggleTheme() {
            const settings = loadSettings();
            const newTheme = settings.theme === 'light' ? 'dark' : 'light';
            settings.theme = newTheme;
            saveSettings(settings);
            applyTheme();
            hapticFeedback('light');
        }
        
        // ========== DOM ELEMENTS ==========
        const elements = {
            screens: {
                welcome: document.getElementById('welcome-screen'),
                connecting: document.getElementById('connecting-screen'),
                chat: document.getElementById('chat-screen'),
                disconnected: document.getElementById('disconnected-screen'),
                error: document.getElementById('error-screen')
            },
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            startBtn: document.getElementById('start-btn'),
            nextBtn: document.getElementById('next-btn'),
            messagesArea: document.getElementById('messages-area'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            typingIndicator: document.getElementById('typing-indicator'),
            stickerPanel: document.getElementById('sticker-panel'),
            stickerGrid: document.getElementById('sticker-grid'),
            connectingTitle: document.getElementById('connecting-title'),
            connectingDesc: document.getElementById('connecting-desc'),
            brokerName: document.getElementById('broker-name'),
            connectionProgress: document.getElementById('connection-progress'),
            retryCount: document.getElementById('retry-count'),
            toast: document.getElementById('toast'),
            imageViewer: document.getElementById('image-viewer'),
            viewerImage: document.getElementById('viewer-image'),
            debugPanel: document.getElementById('debug-panel'),
            debugContent: document.getElementById('debug-content'),
            errorTitle: document.getElementById('error-title'),
            errorDesc: document.getElementById('error-desc'),
            errorDetails: document.getElementById('error-details'),
            footer: document.getElementById('app-footer'),
            aboutModal: document.getElementById('about-modal'),
            settingsModal: document.getElementById('settings-modal'),
            contextMenu: document.getElementById('context-menu'),
            replyBar: document.getElementById('reply-bar'),
            replyPreview: document.getElementById('reply-preview'),
            emptyState: document.getElementById('empty-state'),
            cancelConfirm: document.getElementById('cancel-confirm')
        };
        
        // ========== TEXT SLIDER ==========
        function startTextSlider() {
            const messages = document.querySelectorAll('.slider-message');
            let currentIndex = 0;
            
            messages[0].classList.add('active');
            
            app.sliderIntervalId = setInterval(() => {
                messages[currentIndex].classList.remove('active');
                messages[currentIndex].classList.add('fade-out');
                
                setTimeout(() => {
                    messages[currentIndex].classList.remove('fade-out');
                }, 800);
                
                currentIndex = (currentIndex + 1) % messages.length;
                messages[currentIndex].classList.add('active');
            }, 4000);
        }
        
        function stopTextSlider() {
            if (app.sliderIntervalId) {
                clearInterval(app.sliderIntervalId);
                app.sliderIntervalId = null;
            }
            
            document.querySelectorAll('.slider-message').forEach(msg => {
                msg.classList.remove('active', 'fade-out');
            });
        }
        
        // ========== CANCEL CONFIRMATION ==========
        function handleCancelClick() {
            const settings = loadSettings();
            const elapsed = Date.now() - app.searchStartTime;
            
            if (elapsed >= CONFIG.CANCEL_WAIT_THRESHOLD) {
                elements.cancelConfirm.classList.add('active');
                hapticFeedback('medium');
            } else {
                cancelConnection();
            }
        }
        
        function closeCancelConfirm() {
            elements.cancelConfirm.classList.remove('active');
        }
        
        // ========== SETTINGS MODAL ==========
        function toggleSettings() {
            if (elements.settingsModal.classList.contains('active')) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        function openSettings() {
            const settings = loadSettings();
            elements.settingsModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            hapticFeedback('light');
        }
        
        function closeSettings(event) {
            if (!event || event.target === elements.settingsModal || event.type === 'click') {
                elements.settingsModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        function confirmClearMessages() {
            if (confirm('هل أنت متأكد من حذف جميع الرسائل؟ لا يمكن التراجع عن هذا الإجراء.')) {
                clearAllMessages();
                closeSettings();
                showToast('تم حذف جميع الرسائل', 'success');
                hapticFeedback('medium');
            }
        }
        
        function clearAllMessages() {
            elements.messagesArea.innerHTML = '';
            app.messages = [];
            saveMessages();
            elements.emptyState.style.display = 'flex';
        }
        
        // ========== ABOUT MODAL ==========
        function openAboutModal() {
            if (elements.aboutModal) {
                elements.aboutModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                hapticFeedback('light');
            }
        }
        
        function closeAboutModal(event) {
            if (!event || event.target === elements.aboutModal || event.type === 'click') {
                if (elements.aboutModal) {
                    elements.aboutModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        }
        
        // ========== CONTEXT MENU ==========
        function showContextMenu(messageId, event) {
            event.preventDefault();
            app.selectedMessage = messageId;
            
            const message = app.messages.find(m => m.id === messageId);
            if (!message || message.sender !== 'me') {
                // Hide delete option for received messages
                const deleteItem = elements.contextMenu.querySelector('.context-menu-item.danger');
                if (deleteItem) {
                    deleteItem.style.display = message.sender === 'me' ? 'flex' : 'none';
                }
            }
            
            elements.contextMenu.style.left = event.clientX + 'px';
            elements.contextMenu.style.top = event.clientY + 'px';
            elements.contextMenu.classList.add('active');
            
            hapticFeedback('light');
        }
        
        function hideContextMenu() {
            elements.contextMenu.classList.remove('active');
            app.selectedMessage = null;
        }
        
        function copyMessage() {
            if (app.selectedMessage) {
                const message = app.messages.find(m => m.id === app.selectedMessage);
                if (message && message.text) {
                    navigator.clipboard.writeText(message.text).then(() => {
                        showToast('تم نسخ النص', 'success');
                        hapticFeedback('success');
                    });
                }
            }
            hideContextMenu();
        }
        
        function replyToMessage() {
            if (app.selectedMessage) {
                const message = app.messages.find(m => m.id === app.selectedMessage);
                if (message) {
                    startReply(message);
                }
            }
            hideContextMenu();
        }
        
        function deleteMessage() {
            if (app.selectedMessage) {
                removeMessage(app.selectedMessage);
                showToast('تم حذف الرسالة', 'success');
                hapticFeedback('success');
            }
            hideContextMenu();
        }
        
        // ========== REPLY SYSTEM ==========
        function startReply(message) {
            app.replyToMessage = message;
            elements.replyBar.classList.add('active');
            elements.replyPreview.textContent = message.text.substring(0, 50) + (message.text.length > 50 ? '...' : '');
            elements.messageInput.focus();
            hapticFeedback('light');
        }
        
        function cancelReply() {
            app.replyToMessage = null;
            elements.replyBar.classList.remove('active');
        }
        
        function sendQuickSticker(sticker) {
            if (!app.isConnected) return;
            
            const content = sticker;
            addMessage(content, 'sent', 'sticker', null, app.replyToMessage);
            
            publish(getRoomTopic(app.roomId), {
                type: 'STICKER',
                from: app.myId,
                content: content,
                timestamp: Date.now(),
                replyTo: app.replyToMessage ? app.replyToMessage.id : null
            });
            
            cancelReply();
            playSound('sent');
            hapticFeedback('light');
        }
        
        // ========== MESSAGE MANAGEMENT ==========
        function addMessage(content, type, messageType = 'text', timestamp = null, replyTo = null) {
            const msgId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const msgTimestamp = timestamp || Date.now();
            
            const messageData = {
                id: msgId,
                text: messageType === 'text' ? content : '',
                sticker: messageType === 'sticker' ? content : '',
                image: messageType === 'image' ? content : '',
                type: messageType,
                sender: type,
                timestamp: msgTimestamp,
                replyTo: replyTo
            };
            
            app.messages.push(messageData);
            saveMessages();
            
            // Hide empty state
            elements.emptyState.style.display = 'none';
            
            const msg = document.createElement('div');
            msg.className = 'message ' + type;
            msg.dataset.id = msgId;
            
            // Handle reply indicator
            if (replyTo) {
                const replyMessage = app.messages.find(m => m.id === replyTo);
                if (replyMessage) {
                    const replyIndicator = document.createElement('div');
                    replyIndicator.className = 'reply-indicator';
                    replyIndicator.innerHTML = `
                        <span class="reply-indicator-icon">↩️</span>
                        <div>
                            <div class="reply-indicator-text">رد على رسالة</div>
                            <div class="reply-indicator-original">${replyMessage.text || replyMessage.sticker || replyMessage.image}</div>
                        </div>
                    `;
                    msg.appendChild(replyIndicator);
                }
            }
            
            if (messageType === 'sticker') {
                msg.innerHTML += `<span>${content}</span>`;
            } else if (messageType === 'image') {
                msg.innerHTML += `<img src="${content}" class="message-image" onclick="openImageViewer('${content}')" alt="صورة">`;
            } else {
                msg.textContent = sanitizeText(content);
            }
            
            const time = new Date(msgTimestamp);
            const timeStr = formatMessageTime(msgTimestamp);
            
            msg.innerHTML += `<span class="meta"><span class="message-time" onclick="copyTime('${timeStr}', event)" title="اضغط للنسخ">${timeStr}</span></span>`;
            
            // Add context menu listener
            msg.addEventListener('contextmenu', (e) => showContextMenu(msgId, e));
            msg.addEventListener('click', () => hideContextMenu());
            
            elements.messagesArea.appendChild(msg);
            
            app.messageCount++;
            while (elements.messagesArea.children.length > CONFIG.MAX_MESSAGE_AGE * 2 + 1) {
                const firstChild = elements.messagesArea.firstChild;
                if (firstChild && firstChild.dataset.id) {
                    removeMessage(firstChild.dataset.id, true);
                }
            }
            
            scrollToBottom();
        }
        
        function removeMessage(msgId, fromDomOnly = false) {
            if (!fromDomOnly) {
                const index = app.messages.findIndex(m => m.id === msgId);
                if (index > -1) {
                    app.messages.splice(index, 1);
                    saveMessages();
                }
            }
            
            const msgElement = elements.messagesArea.querySelector(`[data-id="${msgId}"]`);
            if (msgElement) {
                msgElement.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    msgElement.remove();
                    if (elements.messagesArea.children.length <= 1) {
                        elements.emptyState.style.display = 'flex';
                    }
                }, 300);
            }
        }
        
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const isYesterday = date.toDateString() === yesterday.toDateString();
            
            let timeStr = date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            
            if (!isToday && !isYesterday) {
                const dateStr = date.toLocaleDateString('ar-SA', { day: 'numeric', month: 'short' });
                return timeStr + ' · ' + dateStr;
            } else if (isYesterday) {
                return timeStr + ' · أمس';
            }
            
            return timeStr;
        }
        
        function copyTime(timeStr, event) {
            event.stopPropagation();
            navigator.clipboard.writeText(timeStr).then(() => {
                showToast('تم نسخ الوقت', 'success');
                hapticFeedback('light');
            });
        }
        
        function saveMessages() {
            try {
                localStorage.setItem('sodfa_messages', JSON.stringify(app.messages.slice(-20)));
            } catch (e) {
                console.log('Error saving messages');
            }
        }
        
        function loadMessages() {
            try {
                const saved = localStorage.getItem('sodfa_messages');
                if (saved) {
                    app.messages = JSON.parse(saved);
                    app.messages.forEach(msg => {
                        if (msg.type === 'text' || msg.type === 'sticker' || msg.type === 'image') {
                            const content = msg.text || msg.sticker || msg.image;
                            if (content) {
                                addMessage(content, msg.sender, msg.type, msg.timestamp, msg.replyTo);
                            }
                        }
                    });
                }
            } catch (e) {
                console.log('Error loading messages');
            }
        }
        
        // ========== DEBUG LOGGING ==========
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${level}] ${message}`);
            
            const line = document.createElement('div');
            line.className = 'debug-line';
            line.innerHTML = `<span class="debug-timestamp">[${timestamp}]</span> <span style="color: ${level === 'ERROR' ? '#ff4444' : level === 'WARN' ? '#ffaa00' : '#00ff88'}">[${level}]</span> ${message}`;
            elements.debugContent.insertBefore(line, elements.debugContent.firstChild);
            
            while (elements.debugContent.children.length > 50) {
                elements.debugContent.removeChild(elements.debugContent.lastChild);
            }
        }
        
        function toggleDebug() {
            elements.debugPanel.classList.toggle('show');
        }
        
        // ========== INITIALIZATION ==========
        function init() {
            log('INFO', 'Application initialized');
            log('INFO', 'Client ID: ' + app.myId);
            
            // Load settings
            const settings = loadSettings();
            applyTheme();
            document.getElementById('sound-toggle').checked = settings.sound;
            document.getElementById('haptic-toggle').checked = settings.haptic;
            document.getElementById('auto-image-toggle').checked = settings.autoImage;
            document.getElementById('timeout-slider').value = settings.timeout;
            document.getElementById('timeout-value').textContent = settings.timeout + 'ث';
            
            if (typeof mqtt === 'undefined') {
                log('ERROR', 'MQTT library failed to load!');
                showError('فشل تحميل مكتبة الاتصال', 'يرجى تحديث الصفحة أو التحقق من اتصال الإنترنت', 'mqtt.min.js not loaded');
                return;
            }
            
            log('INFO', 'MQTT library loaded successfully');
            initStickers();
            initSounds();
            loadMessages();
            updateStatus('idle');
            
            // Check for notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        function initStickers() {
            elements.stickerGrid.innerHTML = STICKERS.map(s => 
                `<div class="sticker-item" onclick="sendSticker('${s}')">${s}</div>`
            ).join('');
        }
        
        // ========== UI HELPERS ==========
        function showScreen(screenName) {
            Object.values(elements.screens).forEach(s => s.classList.remove('active'));
            elements.screens[screenName].classList.add('active');
        }
        
        function updateStatus(status, text = null) {
            elements.statusDot.className = 'status-dot ' + status;
            elements.statusText.textContent = text || getStatusText(status);
        }
        
        function getStatusText(status) {
            const texts = {
                idle: 'غير متصل',
                connecting: 'جاري الاتصال...',
                searching: 'جاري البحث...',
                negotiating: 'جاري الاتصال...',
                connected: 'متصل',
                error: 'خطأ'
            };
            return texts[status] || status;
        }
        
        function showToast(message, type = 'success') {
            elements.toast.textContent = message;
            elements.toast.className = 'toast show ' + type;
            setTimeout(() => elements.toast.classList.remove('show'), 4000);
        }
        
        function showError(title, desc, details) {
            log('ERROR', details);
            elements.errorTitle.textContent = title;
            elements.errorDesc.textContent = desc;
            elements.errorDetails.textContent = details;
            app.lastError = { title, desc, details };
            updateStatus('error');
            showFooter();
            showScreen('error');
        }
        
        function addSystemMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'system-message';
            msg.textContent = text;
            elements.messagesArea.appendChild(msg);
            scrollToBottom();
        }
        
        function scrollToBottom() {
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
        }
        
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
            handleTyping();
        }
        
        // ========== MQTT CONNECTION ==========
        function getLobbyTopic() { return CONFIG.APP_PREFIX + 'lobby'; }
        function getInboxTopic(id) { return CONFIG.APP_PREFIX + 'inbox/' + id; }
        function getRoomTopic(id) { return CONFIG.APP_PREFIX + 'room/' + id; }
        
        async function connectToBroker(brokerUrl, brokerName) {
            return new Promise((resolve, reject) => {
                log('INFO', `Attempting connection to ${brokerName}`);
                
                if (app.client) {
                    app.isIntentionallyClosing = true;
                    try { app.client.end(); } catch(e) {}
                    app.client = null;
                    app.isIntentionallyClosing = false;
                }
                
                let connected = false;
                let errorOccurred = false;
                
                const timeoutId = setTimeout(() => {
                    if (!connected && !errorOccurred) {
                        errorOccurred = true;
                        log('WARN', `Connection timeout to ${brokerName}`);
                        reject(new Error('Connection timeout'));
                    }
                }, CONFIG.CONNECTION_TIMEOUT);
                
                try {
                    app.client = mqtt.connect(brokerUrl, {
                        clientId: app.myId,
                        clean: true,
                        keepalive: 30,
                        reconnectPeriod: 0,
                        connectTimeout: CONFIG.CONNECTION_TIMEOUT
                    });
                    
                    app.client.on('connect', () => {
                        connected = true;
                        clearTimeout(timeoutId);
                        log('INFO', `Successfully connected to ${brokerName}`);
                        resolve(app.client);
                    });
                    
                    app.client.on('error', (err) => {
                        if (connected) return;
                        errorOccurred = true;
                        clearTimeout(timeoutId);
                        log('ERROR', `Error connecting to ${brokerName}: ${err.message}`);
                        reject(err);
                    });
                    
                    app.client.on('close', () => {
                        if (app.isIntentionallyClosing || connected) return;
                        errorOccurred = true;
                        clearTimeout(timeoutId);
                        log('WARN', `Connection closed to ${brokerName}`);
                        reject(new Error('Connection closed'));
                    });
                    
                    app.client.on('message', handleMessage);
                    
                } catch (err) {
                    errorOccurred = true;
                    clearTimeout(timeoutId);
                    log('ERROR', `Exception connecting to ${brokerName}: ${err.message}`);
                    reject(err);
                }
            });
        }
        
        async function startChat() {
            log('INFO', 'Starting chat process...');
            
            app.reset();
            elements.debugContent.innerHTML = '';
            
            showScreen('connecting');
            updateStatus('connecting');
            elements.startBtn.disabled = true;
            
            let lastError = null;
            
            for (let i = 0; i < CONFIG.BROKERS.length; i++) {
                const broker = CONFIG.BROKERS[i];
                app.brokerIndex = i;
                
                log('INFO', `Broker attempt ${i + 1}/${CONFIG.BROKERS.length}: ${broker.name}`);
                
                elements.connectingTitle.textContent = 'جاري الاتصال...';
                elements.connectingDesc.textContent = 'جاري محاولة الاتصال بالخادم';
                elements.brokerName.textContent = broker.name;
                elements.retryCount.textContent = `محاولة ${i + 1} من ${CONFIG.BROKERS.length}`;
                
                let progress = (i / CONFIG.BROKERS.length) * 100;
                elements.connectionProgress.style.width = progress + '%';
                
                try {
                    await connectToBroker(broker.url, broker.name);
                    log('INFO', 'Connected, starting search...');
                    elements.connectionProgress.style.width = '100%';
                    await startSearch();
                    return;
                    
                } catch (err) {
                    lastError = err;
                    log('WARN', `Failed to connect to ${broker.name}: ${err.message}`);
                    
                    if (i < CONFIG.BROKERS.length - 1) {
                        log('INFO', `Waiting 2 seconds before trying next broker...`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            
            log('ERROR', 'All brokers failed');
            elements.startBtn.disabled = false;
            showError(
                'تعذر الاتصال',
                'حدث خطأ أثناء محاولة الاتصال بجميع الخوادم المتاحة',
                `جميع المحاولات فشلت.\nآخر خطأ: ${lastError?.message || 'Unknown error'}`
            );
        }
        
        function cancelConnection() {
            log('INFO', 'User canceled connection');
            closeCancelConfirm();
            stopTextSlider();
            app.reset();
            elements.startBtn.disabled = false;
            showScreen('welcome');
            updateStatus('idle');
            showToast('تم إلغاء محاولة الاتصال', 'warning');
        }
        
        function retryConnection() {
            log('INFO', 'Retrying connection...');
            startChat();
        }
        
        // ========== SEARCH AND MATCHMAKING ==========
        async function startSearch() {
            log('INFO', 'Starting search for partner...');
            
            app.state = STATES.SEARCHING;
            app.searchStartTime = Date.now();
            updateStatus('searching');
            
            elements.connectingTitle.textContent = 'جاري البحث عن شريك...';
            elements.connectingDesc.textContent = 'قد يستغرق بعض الوقت';
            
            startTextSlider();
            
            subscribe(getLobbyTopic());
            subscribe(getInboxTopic(app.myId));
            
            app.helloIntervalId = setInterval(() => {
                if (app.isSearching) {
                    publish(getLobbyTopic(), {
                        type: 'HELLO',
                        from: app.myId,
                        timestamp: Date.now()
                    });
                }
            }, CONFIG.HELLO_INTERVAL);
            
            let progress = 0;
            app.progressIntervalId = setInterval(() => {
                if (!app.isSearching) {
                    clearInterval(app.progressIntervalId);
                    return;
                }
                progress = (progress + 0.5) % 100;
                elements.connectionProgress.style.width = (50 + progress/2) + '%';
            }, 50);
            
            const settings = loadSettings();
            const timeoutDuration = settings.timeout * 1000;
            
            app.connectionTimeoutId = setTimeout(() => {
                if (app.isSearching) {
                    log('WARN', 'Search timeout - no partners found');
                    elements.connectingTitle.textContent = 'لا يوجد أحد حالياً';
                    elements.connectingDesc.textContent = 'جرب مرة أخرى لاحقاً';
                    elements.retryCount.textContent = 'لا يوجد مستخدمون متاحون';
                    setTimeout(() => {
                        if (app.isSearching) {
                            stopTextSlider();
                            app.reset();
                            elements.startBtn.disabled = false;
                            showScreen('welcome');
                            updateStatus('idle');
                        }
                    }, 3000);
                }
            }, timeoutDuration);
            
            publish(getLobbyTopic(), {
                type: 'HELLO',
                from: app.myId,
                timestamp: Date.now()
            });
        }
        
        function subscribe(topic) {
            if (!app.subscriptions.has(topic) && app.client) {
                app.client.subscribe(topic, (err) => {
                    if (!err) {
                        app.subscriptions.add(topic);
                        log('INFO', 'Subscribed to: ' + topic);
                    } else {
                        log('ERROR', 'Subscribe failed to ' + topic + ': ' + err.message);
                    }
                });
            }
        }
        
        function unsubscribe(topic) {
            if (app.subscriptions.has(topic) && app.client) {
                app.client.unsubscribe(topic, (err) => {
                    if (!err) {
                        app.subscriptions.delete(topic);
                    }
                });
            }
        }
        
        function publish(topic, message) {
            if (app.client && app.client.connected) {
                try {
                    app.client.publish(topic, JSON.stringify(message));
                } catch (err) {
                    log('ERROR', 'Publish failed: ' + err.message);
                }
            }
        }
        
        // ========== MESSAGE HANDLING ==========
        async function handleMessage(topic, message) {
            try {
                const data = JSON.parse(message.toString());
                const from = data.from;
                
                if (from === app.myId) return;
                
                log('INFO', `Message from ${from.substring(0, 8)}: ${data.type}`);
                
                if (topic === getLobbyTopic() && app.isSearching) {
                    if (data.type === 'HELLO') {
                        if (from > app.myId) {
                            log('INFO', `Initiating handshake with ${from.substring(0, 8)}`);
                            await initiateHandshake(from);
                        }
                    }
                }
                
                if (topic === getInboxTopic(app.myId)) {
                    switch (data.type) {
                        case 'OFFER': await handleOffer(data); break;
                        case 'ACCEPT': await handleAccept(data); break;
                        case 'ACK': await handleAck(data); break;
                        case 'BUSY': log('INFO', 'Partner is busy'); break;
                        case 'CANCEL': handleCancel(from); break;
                    }
                }
                
                if (app.isConnected && app.roomId && topic === getRoomTopic(app.roomId)) {
                    switch (data.type) {
                        case 'MSG': 
                            addMessage(data.content, 'received', 'text', data.timestamp, data.replyTo); 
                            playSound('received');
                            hapticFeedback('medium');
                            sendNotification('رسالة جديدة', data.content.substring(0, 30));
                            break;
                        case 'IMAGE': 
                            addMessage(data.content, 'received', 'image', data.timestamp, data.replyTo); 
                            playSound('received');
                            hapticFeedback('medium');
                            sendNotification('صورة جديدة', 'تلقى صورة من الشريك');
                            break;
                        case 'STICKER': 
                            addMessage(data.content, 'received', 'sticker', data.timestamp, data.replyTo); 
                            playSound('received');
                            hapticFeedback('medium');
                            break;
                        case 'TYPING': showPartnerTyping(); break;
                        case 'STOP_TYPING': hidePartnerTyping(); break;
                        case 'BYE': handlePartnerLeft('غادر الشخص المحادثة'); break;
                    }
                }
            } catch (err) {
                log('ERROR', 'Message parse error: ' + err.message);
            }
        }
        
        // ========== NOTIFICATIONS ==========
        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">💬</text></svg>'
                });
            }
        }
        
        // ========== MATCHMAKING PROTOCOL ==========
        async function initiateHandshake(targetId) {
            if (!app.isSearching) return;
            
            log('INFO', `Sending OFFER to ${targetId.substring(0, 8)}`);
            app.state = STATES.NEGOTIATING;
            app.partnerId = targetId;
            
            if (app.helloIntervalId) {
                clearInterval(app.helloIntervalId);
                app.helloIntervalId = null;
            }
            
            const roomId = app.generateUUID();
            publish(getInboxTopic(targetId), {
                type: 'OFFER',
                from: app.myId,
                room: roomId,
                timestamp: Date.now()
            });
            
            app.handshakeTimeoutId = setTimeout(() => {
                log('WARN', 'Handshake timeout');
                if (app.isNegotiating) {
                    publish(getInboxTopic(targetId), { type: 'CANCEL', from: app.myId });
                    cancelHandshake('انتهت مهلة الاتصال');
                }
            }, CONFIG.HANDSHAKE_TIMEOUT);
        }
        
        async function handleOffer(data) {
            if (!app.isSearching && !app.isNegotiating) {
                publish(getInboxTopic(data.from), { type: 'BUSY', from: app.myId });
                return;
            }
            
            log('INFO', `Received OFFER from ${data.from.substring(0, 8)}`);
            
            if (app.helloIntervalId) {
                clearInterval(app.helloIntervalId);
                app.helloIntervalId = null;
            }
            
            app.state = STATES.NEGOTIATING;
            app.partnerId = data.from;
            app.roomId = data.room;
            
            publish(getInboxTopic(data.from), {
                type: 'ACCEPT',
                from: app.myId,
                room: data.room,
                timestamp: Date.now()
            });
            
            app.handshakeTimeoutId = setTimeout(() => {
                if (app.isNegotiating) {
                    publish(getInboxTopic(app.partnerId), { type: 'CANCEL', from: app.myId });
                    cancelHandshake('لم يتم تأكيد الاتصال');
                }
            }, CONFIG.HANDSHAKE_TIMEOUT);
        }
        
        async function handleAccept(data) {
            if (!app.isNegotiating || app.partnerId !== data.from) return;
            
            log('INFO', 'Received ACCEPT');
            
            clearTimeout(app.handshakeTimeoutId);
            app.handshakeTimeoutId = null;
            
            app.roomId = data.room;
            
            publish(getInboxTopic(data.from), {
                type: 'ACK',
                from: app.myId,
                room: data.room,
                timestamp: Date.now()
            });
            
            await establishConnection();
        }
        
        async function handleAck(data) {
            if (!app.isNegotiating || app.partnerId !== data.from) return;
            
            log('INFO', 'Received ACK');
            
            clearTimeout(app.handshakeTimeoutId);
            app.handshakeTimeoutId = null;
            
            app.roomId = data.room;
            await establishConnection();
        }
        
        function handleCancel(from) {
            if (app.isNegotiating && app.partnerId === from) {
                log('INFO', 'Received CANCEL from partner');
                cancelHandshake('ألغى الطرف الآخر الاتصال');
            }
        }
        
        async function establishConnection() {
            log('INFO', `Connected in room: ${app.roomId}`);
            
            stopTextSlider();
            playSound('connect');
            
            app.state = STATES.CONNECTED;
            
            clearTimeout(app.handshakeTimeoutId);
            app.handshakeTimeoutId = null;
            
            subscribe(getRoomTopic(app.roomId));
            
            unsubscribe(getLobbyTopic());
            unsubscribe(getInboxTopic(app.myId));
            
            if (app.helloIntervalId) {
                clearInterval(app.helloIntervalId);
                app.helloIntervalId = null;
            }
            if (app.progressIntervalId) {
                clearInterval(app.progressIntervalId);
                app.progressIntervalId = null;
            }
            
            showScreen('chat');
            hideFooter();
            elements.messagesArea.innerHTML = '';
            elements.emptyState.style.display = 'flex';
            addSystemMessage('تم الاتصال! 👋');
            addSystemMessage('أهلاً وسهلاً! كيف حالك؟');
            
            elements.messageInput.disabled = false;
            elements.sendBtn.disabled = false;
            elements.nextBtn.disabled = false;
            elements.messageInput.focus();
            
            updateStatus('connected');
            showToast('تم الاتصال بشخص غريب!', 'success');
            hapticFeedback('success');
        }
        
        function cancelHandshake(reason) {
            log('WARN', `Handshake cancelled: ${reason}`);
            stopTextSlider();
            app.reset();
            showScreen('welcome');
            updateStatus('idle');
            elements.startBtn.disabled = false;
        }
        
        // ========== CHAT FUNCTIONS ==========
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text || !app.isConnected) return;
            
            addMessage(text, 'sent', 'text', null, app.replyToMessage);
            publish(getRoomTopic(app.roomId), {
                type: 'MSG',
                from: app.myId,
                content: text,
                timestamp: Date.now(),
                replyTo: app.replyToMessage ? app.replyToMessage.id : null
            });
            
            elements.messageInput.value = '';
            elements.messageInput.style.height = 'auto';
            elements.messageInput.focus();
            sendStopTyping();
            
            cancelReply();
            playSound('sent');
            hapticFeedback('light');
        }
        
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // ========== IMAGE SHARING ==========
        function triggerImageUpload() {
            document.getElementById('image-input').click();
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const settings = loadSettings();
            
            if (!file.type.startsWith('image/')) {
                showToast('يرجى اختيار ملف صورة', 'error');
                return;
            }
            
            showToast('جاري معالجة الصورة...', 'warning');
            
            try {
                let compressed;
                if (settings.autoImage) {
                    compressed = await compressImage(file);
                } else {
                    compressed = await fileToDataURL(file);
                }
                
                addMessage(compressed, 'sent', 'image', null, app.replyToMessage);
                
                if (app.isConnected) {
                    publish(getRoomTopic(app.roomId), {
                        type: 'IMAGE',
                        from: app.myId,
                        content: compressed,
                        timestamp: Date.now(),
                        replyTo: app.replyToMessage ? app.replyToMessage.id : null
                    });
                }
                
                cancelReply();
                showToast('تم إرسال الصورة', 'success');
                playSound('sent');
                hapticFeedback('light');
            } catch (err) {
                log('ERROR', 'Image upload failed: ' + err.message);
                showToast('فشل في إرسال الصورة', 'error');
            }
            
            event.target.value = '';
        }
        
        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > CONFIG.MAX_IMAGE_SIZE || height > CONFIG.MAX_IMAGE_SIZE) {
                            if (width > height) {
                                height = (height * CONFIG.MAX_IMAGE_SIZE) / width;
                                width = CONFIG.MAX_IMAGE_SIZE;
                            } else {
                                width = (width * CONFIG.MAX_IMAGE_SIZE) / height;
                                height = CONFIG.MAX_IMAGE_SIZE;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = CONFIG.IMAGE_QUALITY;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        while (dataUrl.length > CONFIG.MAX_PAYLOAD_SIZE && quality > 0.1) {
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        if (dataUrl.length > CONFIG.MAX_PAYLOAD_SIZE) {
                            reject(new Error('Image too large even after compression'));
                        } else {
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }
        
        function openImageViewer(src) {
            elements.viewerImage.src = src;
            elements.imageViewer.classList.add('active');
        }
        
        function closeImageViewer() {
            elements.imageViewer.classList.remove('active');
        }
        
        // ========== STICKERS ==========
        function toggleStickers() {
            elements.stickerPanel.classList.toggle('active');
        }
        
        function sendSticker(sticker) {
            if (!app.isConnected) return;
            
            addMessage(sticker, 'sent', 'sticker', null, app.replyToMessage);
            publish(getRoomTopic(app.roomId), {
                type: 'STICKER',
                from: app.myId,
                content: sticker,
                timestamp: Date.now(),
                replyTo: app.replyToMessage ? app.replyToMessage.id : null
            });
            
            cancelReply();
            playSound('sent');
            hapticFeedback('light');
        }
        
        // ========== TYPING INDICATOR ==========
        function handleTyping() {
            if (!app.isConnected) return;
            
            if (!app.isTyping) {
                app.isTyping = true;
                publish(getRoomTopic(app.roomId), { type: 'TYPING', from: app.myId });
            }
            
            if (app.typingTimeoutId) {
                clearTimeout(app.typingTimeoutId);
            }
            
            app.typingTimeoutId = setTimeout(sendStopTyping, 1000);
        }
        
        function sendStopTyping() {
            if (app.isTyping && app.isConnected) {
                app.isTyping = false;
                publish(getRoomTopic(app.roomId), { type: 'STOP_TYPING', from: app.myId });
            }
        }
        
        function showPartnerTyping() {
            elements.typingIndicator.classList.add('show');
            scrollToBottom();
        }
        
        function hidePartnerTyping() {
            elements.typingIndicator.classList.remove('show');
        }
        
        // ========== FOOTER MANAGEMENT ==========
        function hideFooter() {
            if (elements.footer) {
                elements.footer.style.display = 'none';
            }
        }
        
        function showFooter() {
            if (elements.footer) {
                elements.footer.style.display = 'flex';
            }
        }
        
        // ========== NAVIGATION ==========
        function findNewPartner() {
            log('INFO', 'Finding new partner...');
            
            if (confirm('هل أنت متأكد من إنهاء هذه المحادثة والبحث عن شخص جديد؟')) {
                playSound('disconnect');
                hapticFeedback('medium');
                
                if (app.isConnected && app.roomId) {
                    publish(getRoomTopic(app.roomId), { type: 'BYE', from: app.myId });
                }
                
                cleanup();
                startChat();
            }
        }
        
        function goHome() {
            cleanup();
            showFooter();
            showScreen('welcome');
            updateStatus('idle');
            elements.startBtn.disabled = false;
        }
        
        function cleanup() {
            log('INFO', 'Cleaning up...');
            stopTextSlider();
            app.reset();
            
            elements.messageInput.disabled = true;
            elements.sendBtn.disabled = true;
            elements.nextBtn.disabled = true;
            elements.typingIndicator.classList.remove('show');
            elements.stickerPanel.classList.remove('active');
            cancelReply();
        }
        
        function handlePartnerLeft(reason) {
            log('INFO', 'Partner left: ' + reason);
            playSound('disconnect');
            hapticFeedback('error');
            
            cleanup();
            showFooter();
            
            document.getElementById('disconnect-title').textContent = reason;
            document.getElementById('disconnect-desc').textContent = 'هل تريد التحدث مع شخص آخر؟';
            showScreen('disconnected');
            showToast(reason, 'warning');
        }
        
        // ========== EVENT LISTENERS ==========
        elements.messageInput.addEventListener('input', handleTyping);
        
        window.addEventListener('beforeunload', () => {
            if (app.isConnected && app.roomId) {
                try {
                    navigator.sendBeacon(getRoomTopic(app.roomId), JSON.stringify({ type: 'BYE', from: app.myId }));
                } catch(e) {}
            }
            app.isIntentionallyClosing = true;
            if (app.client) {
                try { app.client.end(); } catch(e) {}
            }
        });
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if ((app.isConnected || app.isSearching) && (!app.client || !app.client.connected)) {
                    log('INFO', 'Tab became visible, reconnecting...');
                    if (app.isConnected) {
                        handlePartnerLeft('انقطع الاتصال');
                    } else {
                        startChat();
                    }
                }
            }
        });
        
        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (elements.aboutModal && elements.aboutModal.classList.contains('active')) {
                    closeAboutModal();
                }
                if (elements.settingsModal && elements.settingsModal.classList.contains('active')) {
                    closeSettings();
                }
                if (elements.contextMenu && elements.contextMenu.classList.contains('active')) {
                    hideContextMenu();
                }
                if (elements.cancelConfirm && elements.cancelConfirm.classList.contains('active')) {
                    closeCancelConfirm();
                }
            }
        });
        
        // Close context menu on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) {
                hideContextMenu();
            }
        });
        
        // ========== START ==========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>