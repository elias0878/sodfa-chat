<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="description" content="ØµØ¯ÙØ© - Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ø¬Ù‡ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„ØºØ±Ø¨Ø§Ø¡">
    <title>ØµØ¯ÙØ© - Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Load MQTT Library first -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        /* ========== CSS Variables & Reset ========== */
        :root {
            --primary-color: #0ea5e9;
            --primary-light: #38bdf8;
            --primary-dark: #0284c7;
            --secondary-color: #10b981;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --self-bubble: linear-gradient(135deg, #0ea5e9, #06b6d4);
            --self-bubble-text: #ffffff;
            --partner-bubble: #f1f5f9;
            --partner-bubble-text: #334155;
            --border-color: #e2e8f0;
            --shadow-soft: 0 2px 8px rgba(14, 165, 233, 0.1);
            --shadow-medium: 0 4px 16px rgba(14, 165, 233, 0.15);
            --shadow-strong: 0 8px 32px rgba(14, 165, 233, 0.2);
            --radius-small: 12px;
            --radius-medium: 16px;
            --radius-large: 24px;
            --radius-pill: 50px;
            --header-height: 60px;
            --input-height: 65px;
            --footer-height: 50px;
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* ========== App Container ========== */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            position: relative;
            overflow: hidden;
        }
        
        /* ========== Header ========== */
        .header {
            background: var(--card-bg);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--header-height);
            min-height: var(--header-height);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            z-index: 1000;
            flex-shrink: 0;
            position: relative;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            min-width: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            transition: all var(--transition-normal);
        }
        
        .status-dot.connected { 
            background: var(--success-color);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        .status-dot.searching { 
            background: var(--primary-color);
            animation: pulse 1s ease-in-out infinite;
        }
        
        .status-dot.error { background: var(--danger-color); }
        .status-dot.connecting { 
            background: var(--warning-color);
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }
        
        .header-right {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .btn-icon {
            width: 38px;
            height: 38px;
            min-width: 38px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-icon:active {
            background: var(--bg-color);
            transform: scale(0.95);
        }
        
        .btn-next {
            background: var(--primary-color);
            color: white;
            padding: 8px 14px;
            min-height: 38px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-soft);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-next:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ========== Screens ========== */
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            height: calc(100% - var(--header-height));
        }
        
        .screen.active {
            display: flex;
            height: 100%;
        }
        
        /* ========== Welcome Screen ========== */
        .welcome-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
            overflow-y: auto;
        }
        
        .welcome-card {
            background: var(--card-bg);
            padding: 40px 28px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 380px;
            width: 100%;
            border: 1px solid var(--border-color);
        }
        
        .welcome-logo {
            font-size: 64px;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .welcome-subtitle {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }
        
        .features-list {
            list-style: none;
            text-align: right;
            margin-bottom: 28px;
        }
        
        .features-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .features-list li:last-child {
            border-bottom: none;
        }
        
        .features-list li::before {
            content: 'âœ“';
            color: var(--success-color);
            font-weight: bold;
        }
        
        .btn-start {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 24px;
            cursor: pointer;
            width: 100%;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-start:active:not(:disabled) {
            transform: scale(0.97);
        }
        
        .btn-start:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ========== Connecting Screen with Text Slider ========== */
        .connecting-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
            position: relative;
        }
        
        .connecting-card {
            background: var(--card-bg);
            padding: 48px 32px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color);
        }
        
        .connecting-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .connecting-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .connecting-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .broker-name {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 11px;
            background: rgba(14, 165, 233, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: inline-block;
            word-break: break-all;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .retry-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .btn-cancel-connect {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            padding: 12px 28px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-cancel-connect:active {
            transform: scale(0.95);
        }
        
        /* ========== Text Slider ========== */
        .text-slider-container {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }
        
        .text-slider {
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slider-message {
            position: absolute;
            width: 100%;
            padding: 0 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.8s ease-in-out;
            pointer-events: none;
        }
        
        .slider-message.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .slider-message.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .slider-message .highlight {
            color: var(--primary-color);
            font-weight: 800;
        }
        
        /* ========== Chat Screen ========== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            overflow: hidden;
            height: 100%;
            padding-bottom: var(--footer-height);
        }
        
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
            background: var(--bg-color);
        }
        
        .messages-area::-webkit-scrollbar {
            width: 4px;
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
            opacity: 0.5;
        }
        
        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: var(--radius-large);
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            transition: transform 0.15s ease;
            box-shadow: var(--shadow-soft);
        }
        
        .message:active {
            transform: scale(0.98);
        }
        
        .message.sent {
            align-self: flex-end;
            background: var(--self-bubble);
            color: var(--self-bubble-text);
            border-bottom-left-radius: 4px;
            margin-left: 16px;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--partner-bubble);
            color: var(--partner-bubble-text);
            border-bottom-right-radius: 4px;
            margin-right: 16px;
        }
        
        .message .meta {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            display: block;
        }
        
        /* Message Types */
        .message.sticker {
            padding: 6px 10px;
            background: transparent !important;
            box-shadow: none !important;
        }
        
        .message.sticker.sent {
            align-self: flex-end;
            margin-left: 10%;
        }
        
        .message.sticker.received {
            align-self: flex-start;
            margin-right: 10%;
        }
        
        .message.sticker span {
            font-size: 48px;
            display: block;
        }
        
        .message.image {
            padding: 4px;
            background: transparent !important;
            box-shadow: none !important;
        }
        
        .message.image.sent {
            align-self: flex-end;
            margin-left: 10%;
        }
        
        .message.image.received {
            align-self: flex-start;
            margin-right: 10%;
        }
        
        .message-image {
            max-width: 100%;
            border-radius: 12px;
            cursor: pointer;
            display: block;
        }
        
        .system-message {
            align-self: center;
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            text-align: center;
            max-width: 90%;
            font-weight: 600;
        }
        
        /* ========== Typing Indicator ========== */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 10px 14px;
            color: var(--text-secondary);
            font-size: 12px;
            margin: 0 0 8px 0;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 6px;
            vertical-align: middle;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        
        /* ========== Stickers Panel ========== */
        .sticker-panel {
            display: none;
            position: fixed;
            bottom: calc(var(--input-height) + var(--footer-height) + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: var(--shadow-strong);
            padding: 16px;
            z-index: 999;
            border: 1px solid var(--border-color);
            width: calc(100% - 32px);
            max-width: 400px;
            box-sizing: border-box;
        }
        
        .sticker-panel.active {
            display: block;
        }
        
        .sticker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sticker-header h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .sticker-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--bg-color);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sticker-close:active {
            background: var(--danger-color);
            color: white;
        }
        
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
            padding: 4px;
        }
        
        .sticker-item {
            font-size: 28px;
            text-align: center;
            padding: 6px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.1s ease;
        }
        
        .sticker-item:active {
            transform: scale(0.85);
        }
        
        /* ========== Input Area ========== */
        .input-area {
            background: var(--card-bg);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            min-height: var(--input-height);
            height: var(--input-height);
            box-sizing: border-box;
            position: absolute;
            bottom: var(--footer-height);
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .input-actions {
            display: flex;
            gap: 4px;
        }
        
        .btn-action {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary-color);
            transition: all var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-action:active {
            background: rgba(14, 165, 233, 0.1);
            transform: scale(0.9);
        }
        
        .input-wrapper {
            flex: 1;
            background: var(--bg-color);
            border-radius: 24px;
            padding: 4px 4px 4px 16px;
            display: flex;
            align-items: center;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }
        
        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            background: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .input-wrapper input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 15px;
            outline: none;
            color: var(--text-primary);
            padding: 8px 0;
        }
        
        .input-wrapper input::placeholder {
            color: var(--text-secondary);
        }
        
        .btn-send {
            width: 44px;
            height: 44px;
            min-width: 44px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-soft);
        }
        
        .btn-send:active:not(:disabled) {
            transform: scale(0.9);
        }
        
        .btn-send:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }
        
        /* ========== Footer ========== */
        .footer {
            background: var(--card-bg);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-top: 1px solid var(--border-color);
            height: var(--footer-height);
            min-height: var(--footer-height);
            flex-shrink: 0;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99;
        }
        
        .footer-text {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .footer-link {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-decoration: none;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-soft);
        }
        
        .footer-link:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .footer-link:active {
            transform: scale(0.95);
        }
        
        /* ========== About Modal ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 24px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            border: 1px solid var(--border-color);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .modal-close:active {
            background: var(--danger-color);
            color: white;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .about-section {
            margin-bottom: 28px;
        }
        
        .about-section:last-child {
            margin-bottom: 0;
        }
        
        .about-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .about-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.8;
        }
        
        .services-list {
            list-style: none;
        }
        
        .service-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: var(--bg-color);
            border-radius: 14px;
            margin-bottom: 10px;
            transition: all var(--transition-fast);
        }
        
        .service-item:last-child {
            margin-bottom: 0;
        }
        
        .service-item:active {
            transform: scale(0.98);
            background: rgba(14, 165, 233, 0.08);
        }
        
        .service-icon {
            font-size: 22px;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 10px;
        }
        
        .service-info {
            flex: 1;
        }
        
        .service-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .service-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .cta-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-medium);
        }
        
        .cta-button:active {
            transform: scale(0.97);
        }
        
        .modal-footer {
            padding: 16px 24px 20px;
            text-align: center;
        }
        
        .modal-footer-text {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .modal-footer-link {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }
        
        .modal-footer-link:active {
            text-decoration: underline;
        }
        
        /* Safe area for modal */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .modal-content {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        .footer-icon {
            font-size: 14px;
        }
        
        /* ========== Disconnected Screen ========== */
        .disconnected-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
        }
        
        .disconnected-card {
            background: var(--card-bg);
            padding: 48px 28px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 380px;
            width: 100%;
            border: 1px solid var(--border-color);
        }
        
        .disconnected-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .disconnected-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .disconnected-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 28px;
        }
        
        .btn-reconnect {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 700;
            border-radius: 24px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-reconnect:active {
            transform: scale(0.97);
        }
        
        .btn-home {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            padding: 12px 28px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-home:active {
            transform: scale(0.97);
        }
        
        /* ========== Error Screen ========== */
        .error-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #f0f9ff 0%, var(--card-bg) 100%);
            height: 100%;
        }
        
        .error-card {
            background: var(--card-bg);
            padding: 44px 28px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color);
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--danger-color);
        }
        
        .error-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .error-details {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 12px;
            font-size: 10px;
            font-family: monospace;
            text-align: right;
            margin: 16px 0;
            max-height: 80px;
            overflow-y: auto;
            word-break: break-all;
        }
        
        .btn-retry {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 700;
            border-radius: 24px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-retry:active {
            transform: scale(0.97);
        }
        
        /* ========== Toast Notifications ========== */
        .toast {
            position: fixed;
            bottom: calc(var(--input-height) + var(--footer-height) + 60px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow-strong);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 3000;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
            visibility: visible;
        }
        
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.warning { background: var(--warning-color); }
        
        /* ========== Image Viewer ========== */
        .image-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .image-viewer.active {
            display: flex;
        }
        
        .image-viewer img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 12px;
        }
        
        .image-viewer-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ========== Hidden Inputs ========== */
        .hidden-input {
            display: none;
        }
        
        /* ========== Debug Panel ========== */
        .debug-panel {
            display: none;
            position: fixed;
            top: calc(var(--header-height) + 10px);
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 12px;
            font-size: 10px;
            color: #00ff88;
            max-width: 260px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 999;
            font-family: monospace;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-title {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 11px;
        }
        
        .debug-line {
            margin: 2px 0;
            word-break: break-all;
        }
        
        .debug-timestamp {
            color: #888;
        }
        
        /* ========== Mobile Responsive ========== */
        @media (max-width: 400px) {
            .header {
                padding: 0 10px;
            }
            
            .app-title {
                font-size: 16px;
            }
            
            .status-indicator {
                display: none;
            }
            
            .btn-next {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .btn-icon {
                width: 34px;
                height: 34px;
                min-width: 34px;
                font-size: 14px;
            }
            
            .message {
                max-width: 82%;
                font-size: 14px;
                padding: 10px 14px;
            }
            
            .sticker-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .sticker-item {
                font-size: 24px;
                padding: 4px;
            }
            
            .message.sticker span {
                font-size: 40px;
            }
            
            .slider-message {
                font-size: 13px;
            }
        }
        
        /* ========== Safe Area for Notched Phones ========== */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .input-area {
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
            
            .footer {
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
            }
            
            .toast {
                bottom: calc(var(--input-height) + var(--footer-height) + 10px + env(safe-area-inset-bottom));
            }
            
            .sticker-panel {
                bottom: calc(var(--input-height) + var(--footer-height) + 10px + env(safe-area-inset-bottom));
            }
        }
        
        /* ========== Reduced Motion ========== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span class="app-title">ØµØ¯ÙØ©</span>
                <div class="status-indicator">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="status-text">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn-icon" onclick="openAboutModal()" title="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª">â„¹ï¸</button>
                <button class="btn-icon" onclick="toggleDebug()" title="ØªØµØ­ÙŠØ­">âš™ï¸</button>
                <button class="btn-next" id="next-btn" onclick="findNewPartner()" disabled>
                    <span>ğŸ²</span>
                    <span>Ø´Ø®Øµ Ø¢Ø®Ø±</span>
                </button>
            </div>
        </header>
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <div class="welcome-screen">
                <div class="welcome-card">
                    <div class="welcome-logo">ğŸ’¬</div>
                    <h1 class="welcome-title">ØµØ¯ÙØ©</h1>
                    <p class="welcome-subtitle">Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ø¬Ù‡ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„ØºØ±Ø¨Ø§Ø¡</p>
                    <ul class="features-list">
                        <li>Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© ÙˆÙ…Ø¬Ù‡ÙˆÙ„Ø© ØªÙ…Ø§Ù…Ø§Ù‹</li>
                        <li>Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ± ÙˆÙ…Ù„ØµÙ‚Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©</li>
                        <li>Ù†Ø¸Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø°ÙƒÙŠ ÙˆÙ…ÙˆØ«ÙˆÙ‚</li>
                        <li>Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚Ø§Øª</li>
                    </ul>
                    <button class="btn-start" id="start-btn" onclick="startChat()">
                        <span>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¢Ù†</span>
                        <span>ğŸš€</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Connecting Screen -->
        <div id="connecting-screen" class="screen">
            <div class="connecting-screen">
                <div class="connecting-card">
                    <div class="connecting-spinner"></div>
                    <h2 class="connecting-title" id="connecting-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ...</h2>
                    <p class="connecting-desc" id="connecting-desc">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†</p>
                    <div class="broker-name" id="broker-name">---</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="connection-progress"></div>
                    </div>
                    <p class="retry-count" id="retry-count"></p>
                    <button class="btn-cancel-connect" onclick="cancelConnection()">Ø¥Ù„ØºØ§Ø¡</button>
                    
                    <!-- Text Slider -->
                    <div class="text-slider-container">
                        <div class="text-slider" id="text-slider">
                            <div class="slider-message" data-index="0">
                                <span class="highlight">ÙØ±ÙŠÙ‚ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ù</span> Ù‡Ù†Ø§ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ù…Ø³Ø±ÙˆÙ‚
                            </div>
                            <div class="slider-message" data-index="1">
                                Ø­Ø³Ø§Ø¨Ùƒ <span class="highlight">Ù…ØºÙ„Ù‚ Ø£Ùˆ Ù…Ø¹Ø·Ù„</span>ØŸ Ù†Ø­Ù† Ø§Ù„Ø­Ù„
                            </div>
                            <div class="slider-message" data-index="2">
                                ØªØªØ¹Ø±Ø¶ Ù„Ù„Ø§Ø¨ØªØ²Ø§Ø²ØŸ ØªÙˆØ§ØµÙ„ Ù…Ø¹ <span class="highlight">ÙØ±ÙŠÙ‚ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ù</span> Ø¨Ø³Ø±ÙŠØ©
                            </div>
                            <div class="slider-message" data-index="3">
                                Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ <span class="highlight">ÙØ±ÙŠÙ‚ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ù</span>å¸®åŠ©ä½ 
                            </div>
                            <div class="slider-message" data-index="4">
                                ØªØ­ØªØ§Ø¬ Ù„ÙØ­Øµ Ø£Ù…Ø§Ù†ÙƒØŸ <span class="highlight">Ù‡ÙƒØ± Ø£Ø®Ù„Ø§Ù‚ÙŠ</span> Ø®Ø¨ÙŠØ±
                            </div>
                            <div class="slider-message" data-index="5">
                                <span class="highlight">ÙØ±ÙŠÙ‚ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ù</span> - Ø®Ø¯Ù…Ø§Øª ØªÙ‚Ù†ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø©
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Screen -->
        <div id="chat-screen" class="screen">
            <div class="chat-container">
                <div class="messages-area" id="messages-area"></div>
                <div class="typing-indicator" id="typing-indicator">
                    <span class="typing-dots"><span></span><span></span><span></span></span>
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...
                </div>
                
                <!-- Sticker Panel -->
                <div class="sticker-panel" id="sticker-panel">
                    <div class="sticker-header">
                        <h4>Ù…Ù„ØµÙ‚Ø§Øª</h4>
                        <button class="sticker-close" onclick="toggleStickers()">âœ•</button>
                    </div>
                    <div class="sticker-grid" id="sticker-grid"></div>
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-actions">
                        <button class="btn-action" onclick="toggleStickers()" title="Ù…Ù„ØµÙ‚Ø§Øª">ğŸ˜Š</button>
                        <button class="btn-action" onclick="triggerImageUpload()" title="ØµÙˆØ±Ø©">ğŸ“·</button>
                    </div>
                    <div class="input-wrapper">
                        <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="handleEnter(event)" disabled>
                    </div>
                    <button class="btn-send" id="send-btn" onclick="sendMessage()" disabled>âœˆï¸</button>
                </div>
            </div>
        </div>
        
        <!-- Disconnected Screen -->
        <div id="disconnected-screen" class="screen">
            <div class="disconnected-screen">
                <div class="disconnected-card">
                    <div class="disconnected-icon">ğŸ‘‹</div>
                    <h2 class="disconnected-title" id="disconnect-title">ØºØ§Ø¯Ø± Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
                    <p class="disconnected-desc" id="disconnect-desc">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø´Ø®Øµ Ø¢Ø®Ø±ØŸ</p>
                    <button class="btn-reconnect" onclick="findNewPartner()">
                        <span>Ø¨Ø­Ø« Ø¹Ù† Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</span>
                        <span>ğŸ”</span>
                    </button>
                    <button class="btn-home" onclick="goHome()">
                        <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                        <span>ğŸ </span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Error Screen -->
        <div id="error-screen" class="screen">
            <div class="error-screen">
                <div class="error-card">
                    <div class="error-icon">âš ï¸</div>
                    <h2 class="error-title" id="error-title">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h2>
                    <p class="error-desc" id="error-desc">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</p>
                    <div class="error-details" id="error-details"></div>
                    <button class="btn-retry" onclick="retryConnection()">
                        <span>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</span>
                        <span>ğŸ”„</span>
                    </button>
                    <button class="btn-home" onclick="goHome()">
                        <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                        <span>ğŸ </span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer" id="app-footer">
            <span class="footer-text">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ø¨ÙˆØ§Ø³Ø·Ø© </span>
            <a href="https://elias0878.github.io/accounts/" target="_blank" class="footer-link">
                <span class="footer-icon">ğŸ›¡ï¸</span>
                <span>ÙØ±ÙŠÙ‚ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ù</span> ğŸ‡¸ğŸ‡¦
            </a>
        </footer>
        
        <!-- About Modal -->
        <div class="modal-overlay" id="about-modal" onclick="closeAboutModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <span>ğŸ’¬</span>
                        <span>Ø¹Ù† ØµØ¯ÙØ©</span>
                    </h3>
                    <button class="modal-close" onclick="closeAboutModal()">âœ•</button>
                </div>
                <div class="modal-body">
                    <div class="about-section">
                        <h4 class="about-title">
                            <span>â„¹ï¸</span>
                            <span>Ù…Ù†ØµØ© ØµØ¯ÙØ©</span>
                        </h4>
                        <p class="about-text">
                            ØµØ¯ÙØ© Ù‡ÙŠ Ù…Ù†ØµØ© Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© Ø¢Ù…Ù†Ø©ØŒ ØªÙ…Ù†Ø­Ùƒ Ø­Ø±ÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¨Ø®ØµÙˆØµÙŠØ© ØªØ§Ù…Ø© ÙˆØ¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„. Ù†Ø¶Ù…Ù† Ù„Ùƒ Ø¨ÙŠØ¦Ø© Ù…Ø­Ù…ÙŠØ© ÙˆØªÙ‚Ù†ÙŠØ§Øª ØªØ´ÙÙŠØ± Ù…ØªÙ‚Ø¯Ù…Ø©.
                        </p>
                    </div>
                    
                    <div class="about-section">
                        <h4 class="about-title">
                            <span>ğŸ›¡ï¸</span>
                            <span>Ø®Ø¯Ù…Ø§Øª ÙØ±ÙŠÙ‚ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ù</span>
                        </h4>
                        <ul class="services-list">
                            <li class="service-item">
                                <div class="service-icon">ğŸ”</div>
                                <div class="service-info">
                                    <div class="service-name">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
                                    <div class="service-desc">Ø³Ù†Ø§Ø¨ØŒ Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…ØŒ ØªÙˆÙŠØªØ± ÙˆØ­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</div>
                                </div>
                            </li>
                            <li class="service-item">
                                <div class="service-icon">ğŸ›¡ï¸</div>
                                <div class="service-info">
                                    <div class="service-name">Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ</div>
                                    <div class="service-desc">Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø¨ØªØ²Ø§Ø² ÙˆØ§Ù„Ø§Ø®ØªØ±Ø§Ù‚</div>
                                </div>
                            </li>
                            <li class="service-item">
                                <div class="service-icon">ğŸ’»</div>
                                <div class="service-info">
                                    <div class="service-name">Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª ÙˆØ§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</div>
                                    <div class="service-desc">Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø®Ø§ØµØ© ÙˆØ§Ø³ØªØ´Ø§Ø±Ø§Øª ØªÙ‚Ù†ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø©</div>
                                </div>
                            </li>
                        </ul>
                        <button class="cta-button" onclick="window.open('https://elias0878.github.io/accounts/', '_blank')">
                            <span>ğŸ“</span>
                            <span>ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ / Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <p class="modal-footer-text">
                        ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ø¨ÙˆØ§Ø³Ø·Ø© 
                        <a href="https://elias0878.github.io/accounts/" target="_blank" class="modal-footer-link">ÙØ±ÙŠÙ‚ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ù</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Image Viewer -->
    <div class="image-viewer" id="image-viewer" onclick="closeImageViewer()">
        <button class="image-viewer-close" onclick="closeImageViewer()">âœ•</button>
        <img id="viewer-image" src="" alt="ØµÙˆØ±Ø© Ù…ÙƒØ¨Ø±Ø©">
    </div>
    
    <!-- Hidden Inputs -->
    <input type="file" id="image-input" class="hidden-input" accept="image/*" onchange="handleImageUpload(event)">
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debug-panel">
        <div class="debug-title">ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ØªØµØ­ÙŠØ­</div>
        <div id="debug-content"></div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            BROKERS: [
                { url: 'wss://broker.emqx.io:8084/mqtt', name: 'EMQX (Primary)' },
                { url: 'wss://broker.hivemq.com:8000/mqtt', name: 'HiveMQ' },
                { url: 'wss://test.mosquitto.org:8081', name: 'Mosquitto Test' },
                { url: 'wss://mqtt.eclipseprojects.io:443/mqtt', name: 'Eclipse' }
            ],
            APP_PREFIX: 'sodfa_v5_',
            HELLO_INTERVAL: 2000,
            HANDSHAKE_TIMEOUT: 8000,
            CONNECTION_TIMEOUT: 15000,
            MAX_MESSAGE_AGE: 50,
            MAX_IMAGE_SIZE: 800,
            IMAGE_QUALITY: 0.7,
            MAX_PAYLOAD_SIZE: 100000,
            MAX_RETRIES: 3
        };
        
        // ========== STICKERS ==========
        const STICKERS = [
            'ğŸ‘‹', 'ğŸ¤', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ',
            'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜',
            'ğŸ’', 'ğŸ’Ÿ', 'â£ï¸', 'ğŸ’Œ', 'ğŸ’‹', 'ğŸ’¬', 'ğŸ’­', 'ğŸ’¤', 'ğŸ’¢', 'ğŸ’¥',
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ˜Š',
            'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ˜‹', 'ğŸ˜›',
            'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨',
            'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”',
            'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ',
            'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•',
            'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥',
            'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±',
            'ğŸ‘¶', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨', 'ğŸ‘µ', 'ğŸ§“', 'ğŸ‘´',
            'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯',
            'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†',
            'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'ğŸŒ™', 'â˜€ï¸', 'ğŸŒˆ', 'âš¡', 'ğŸ‰', 'ğŸŠ',
            'ğŸµ', 'ğŸ¶', 'ğŸ¤', 'ğŸ§', 'ğŸ•', 'ğŸ”', 'ğŸŸ', 'ğŸ“±', 'ğŸ’»', 'âœ…'
        ];
        
        // ========== STATE MANAGEMENT ==========
        const STATES = {
            IDLE: 'IDLE',
            CONNECTING: 'CONNECTING',
            SEARCHING: 'SEARCHING',
            NEGOTIATING: 'NEGOTIATING',
            CONNECTED: 'CONNECTED',
            ERROR: 'ERROR'
        };
        
        class AppState {
            constructor() {
                this.state = STATES.IDLE;
                this.myId = this.generateUUID();
                this.client = null;
                this.currentBroker = null;
                this.brokerIndex = 0;
                this.retryCount = 0;
                this.partnerId = null;
                this.roomId = null;
                this.helloIntervalId = null;
                this.handshakeTimeoutId = null;
                this.connectionTimeoutId = null;
                this.progressIntervalId = null;
                this.typingTimeoutId = null;
                this.partnerTyping = false;
                this.isTyping = false;
                this.subscriptions = new Set();
                this.messageCount = 0;
                this.isIntentionallyClosing = false;
                this.lastError = null;
                this.sliderIntervalId = null;
            }
            
            generateUUID() {
                return 'xxxx-xxxx-xxxx-xxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                }) + '-' + Date.now().toString(36);
            }
            
            get isSearching() { return this.state === STATES.SEARCHING; }
            get isNegotiating() { return this.state === STATES.NEGOTIATING; }
            get isConnected() { return this.state === STATES.CONNECTED; }
            get isIdle() { return this.state === STATES.IDLE; }
            get isConnecting() { return this.state === STATES.CONNECTING; }
            
            reset() {
                this.cleanup();
                this.state = STATES.IDLE;
                this.partnerId = null;
                this.roomId = null;
                this.partnerTyping = false;
                this.isTyping = false;
                this.messageCount = 0;
                this.brokerIndex = 0;
                this.retryCount = 0;
            }
            
            cleanup() {
                const ids = ['helloIntervalId', 'handshakeTimeoutId', 'connectionTimeoutId', 'progressIntervalId', 'typingTimeoutId'];
                ids.forEach(id => {
                    if (this[id]) {
                        clearTimeout(this[id]);
                        clearInterval(this[id]);
                        this[id] = null;
                    }
                });
                
                if (this.sliderIntervalId) {
                    clearInterval(this.sliderIntervalId);
                    this.sliderIntervalId = null;
                }
                
                if (this.client && this.client.connected) {
                    this.isIntentionallyClosing = true;
                    try {
                        this.client.end(false, () => {
                            console.log('[MQTT] Connection closed gracefully');
                        });
                    } catch(e) {}
                    this.isIntentionallyClosing = false;
                }
                this.client = null;
                this.subscriptions.clear();
            }
        }
        
        const app = new AppState();
        
        // ========== DOM ELEMENTS ==========
        const elements = {
            screens: {
                welcome: document.getElementById('welcome-screen'),
                connecting: document.getElementById('connecting-screen'),
                chat: document.getElementById('chat-screen'),
                disconnected: document.getElementById('disconnected-screen'),
                error: document.getElementById('error-screen')
            },
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            startBtn: document.getElementById('start-btn'),
            nextBtn: document.getElementById('next-btn'),
            messagesArea: document.getElementById('messages-area'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            typingIndicator: document.getElementById('typing-indicator'),
            stickerPanel: document.getElementById('sticker-panel'),
            stickerGrid: document.getElementById('sticker-grid'),
            connectingTitle: document.getElementById('connecting-title'),
            connectingDesc: document.getElementById('connecting-desc'),
            brokerName: document.getElementById('broker-name'),
            connectionProgress: document.getElementById('connection-progress'),
            retryCount: document.getElementById('retry-count'),
            toast: document.getElementById('toast'),
            imageViewer: document.getElementById('image-viewer'),
            viewerImage: document.getElementById('viewer-image'),
            debugPanel: document.getElementById('debug-panel'),
            debugContent: document.getElementById('debug-content'),
            errorTitle: document.getElementById('error-title'),
            errorDesc: document.getElementById('error-desc'),
            errorDetails: document.getElementById('error-details'),
            footer: document.getElementById('app-footer'),
            aboutModal: document.getElementById('about-modal')
        };
        
        // ========== TEXT SLIDER ==========
        function startTextSlider() {
            const messages = document.querySelectorAll('.slider-message');
            let currentIndex = 0;
            
            // Show first message immediately
            messages[0].classList.add('active');
            
            app.sliderIntervalId = setInterval(() => {
                messages[currentIndex].classList.remove('active');
                messages[currentIndex].classList.add('fade-out');
                
                setTimeout(() => {
                    messages[currentIndex].classList.remove('fade-out');
                }, 800);
                
                currentIndex = (currentIndex + 1) % messages.length;
                messages[currentIndex].classList.add('active');
            }, 4000);
        }
        
        function stopTextSlider() {
            if (app.sliderIntervalId) {
                clearInterval(app.sliderIntervalId);
                app.sliderIntervalId = null;
            }
            
            // Reset all messages
            document.querySelectorAll('.slider-message').forEach(msg => {
                msg.classList.remove('active', 'fade-out');
            });
        }
        
        // ========== ABOUT MODAL ==========
        function openAboutModal() {
            if (elements.aboutModal) {
                elements.aboutModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeAboutModal(event) {
            if (!event || event.target === elements.aboutModal || event.type === 'click') {
                if (elements.aboutModal) {
                    elements.aboutModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        }
        
        // ========== DEBUG LOGGING ==========
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${level}] ${message}`);
            
            const line = document.createElement('div');
            line.className = 'debug-line';
            line.innerHTML = `<span class="debug-timestamp">[${timestamp}]</span> <span style="color: ${level === 'ERROR' ? '#ff4444' : level === 'WARN' ? '#ffaa00' : '#00ff88'}">[${level}]</span> ${message}`;
            elements.debugContent.insertBefore(line, elements.debugContent.firstChild);
            
            while (elements.debugContent.children.length > 50) {
                elements.debugContent.removeChild(elements.debugContent.lastChild);
            }
        }
        
        function toggleDebug() {
            elements.debugPanel.classList.toggle('show');
        }
        
        // ========== INITIALIZATION ==========
        function init() {
            log('INFO', 'Application initialized');
            log('INFO', 'Client ID: ' + app.myId);
            
            if (typeof mqtt === 'undefined') {
                log('ERROR', 'MQTT library failed to load!');
                showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'mqtt.min.js not loaded');
                return;
            }
            
            log('INFO', 'MQTT library loaded successfully');
            initStickers();
            updateStatus('idle');
        }
        
        function initStickers() {
            elements.stickerGrid.innerHTML = STICKERS.map(s => 
                `<div class="sticker-item" onclick="sendSticker('${s}')">${s}</div>`
            ).join('');
        }
        
        // ========== UI HELPERS ==========
        function showScreen(screenName) {
            Object.values(elements.screens).forEach(s => s.classList.remove('active'));
            elements.screens[screenName].classList.add('active');
        }
        
        function updateStatus(status, text = null) {
            elements.statusDot.className = 'status-dot ' + status;
            elements.statusText.textContent = text || getStatusText(status);
        }
        
        function getStatusText(status) {
            const texts = {
                idle: 'ØºÙŠØ± Ù…ØªØµÙ„',
                connecting: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...',
                searching: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...',
                negotiating: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...',
                connected: 'Ù…ØªØµÙ„',
                error: 'Ø®Ø·Ø£'
            };
            return texts[status] || status;
        }
        
        function showToast(message, type = 'success') {
            elements.toast.textContent = message;
            elements.toast.className = 'toast show ' + type;
            setTimeout(() => elements.toast.classList.remove('show'), 4000);
        }
        
        function showError(title, desc, details) {
            log('ERROR', details);
            elements.errorTitle.textContent = title;
            elements.errorDesc.textContent = desc;
            elements.errorDetails.textContent = details;
            app.lastError = { title, desc, details };
            updateStatus('error');
            showFooter();
            showScreen('error');
        }
        
        function addSystemMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'system-message';
            msg.textContent = text;
            elements.messagesArea.appendChild(msg);
            scrollToBottom();
        }
        
        function addMessage(content, type, messageType = 'text') {
            const msg = document.createElement('div');
            msg.className = 'message ' + type;
            
            if (messageType === 'sticker') {
                msg.innerHTML = `<span>${content}</span>`;
            } else if (messageType === 'image') {
                msg.innerHTML = `<img src="${content}" class="message-image" onclick="openImageViewer('${content}')" alt="ØµÙˆØ±Ø©">`;
            } else {
                msg.textContent = sanitizeText(content);
            }
            
            const time = new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            msg.innerHTML += `<span class="meta">${time}</span>`;
            
            elements.messagesArea.appendChild(msg);
            
            app.messageCount++;
            while (elements.messagesArea.children.length > CONFIG.MAX_MESSAGE_AGE * 2) {
                elements.messagesArea.removeChild(elements.messagesArea.firstChild);
            }
            
            scrollToBottom();
        }
        
        function scrollToBottom() {
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
        }
        
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== MQTT CONNECTION ==========
        function getLobbyTopic() { return CONFIG.APP_PREFIX + 'lobby'; }
        function getInboxTopic(id) { return CONFIG.APP_PREFIX + 'inbox/' + id; }
        function getRoomTopic(id) { return CONFIG.APP_PREFIX + 'room/' + id; }
        
        async function connectToBroker(brokerUrl, brokerName) {
            return new Promise((resolve, reject) => {
                log('INFO', `Attempting connection to ${brokerName}`);
                
                if (app.client) {
                    app.isIntentionallyClosing = true;
                    try { app.client.end(); } catch(e) {}
                    app.client = null;
                    app.isIntentionallyClosing = false;
                }
                
                let connected = false;
                let errorOccurred = false;
                
                const timeoutId = setTimeout(() => {
                    if (!connected && !errorOccurred) {
                        errorOccurred = true;
                        log('WARN', `Connection timeout to ${brokerName}`);
                        reject(new Error('Connection timeout'));
                    }
                }, CONFIG.CONNECTION_TIMEOUT);
                
                try {
                    app.client = mqtt.connect(brokerUrl, {
                        clientId: app.myId,
                        clean: true,
                        keepalive: 30,
                        reconnectPeriod: 0,
                        connectTimeout: CONFIG.CONNECTION_TIMEOUT
                    });
                    
                    app.client.on('connect', () => {
                        connected = true;
                        clearTimeout(timeoutId);
                        log('INFO', `Successfully connected to ${brokerName}`);
                        resolve(app.client);
                    });
                    
                    app.client.on('error', (err) => {
                        if (connected) return;
                        errorOccurred = true;
                        clearTimeout(timeoutId);
                        log('ERROR', `Error connecting to ${brokerName}: ${err.message}`);
                        reject(err);
                    });
                    
                    app.client.on('close', () => {
                        if (app.isIntentionallyClosing || connected) return;
                        errorOccurred = true;
                        clearTimeout(timeoutId);
                        log('WARN', `Connection closed to ${brokerName}`);
                        reject(new Error('Connection closed'));
                    });
                    
                    app.client.on('message', handleMessage);
                    
                } catch (err) {
                    errorOccurred = true;
                    clearTimeout(timeoutId);
                    log('ERROR', `Exception connecting to ${brokerName}: ${err.message}`);
                    reject(err);
                }
            });
        }
        
        async function startChat() {
            log('INFO', 'Starting chat process...');
            
            app.reset();
            elements.debugContent.innerHTML = '';
            
            showScreen('connecting');
            updateStatus('connecting');
            elements.startBtn.disabled = true;
            
            let lastError = null;
            
            for (let i = 0; i < CONFIG.BROKERS.length; i++) {
                const broker = CONFIG.BROKERS[i];
                app.brokerIndex = i;
                
                log('INFO', `Broker attempt ${i + 1}/${CONFIG.BROKERS.length}: ${broker.name}`);
                
                elements.connectingTitle.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                elements.connectingDesc.textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
                elements.brokerName.textContent = broker.name;
                elements.retryCount.textContent = `Ù…Ø­Ø§ÙˆÙ„Ø© ${i + 1} Ù…Ù† ${CONFIG.BROKERS.length}`;
                
                let progress = (i / CONFIG.BROKERS.length) * 100;
                elements.connectionProgress.style.width = progress + '%';
                
                try {
                    await connectToBroker(broker.url, broker.name);
                    log('INFO', 'Connected, starting search...');
                    elements.connectionProgress.style.width = '100%';
                    await startSearch();
                    return;
                    
                } catch (err) {
                    lastError = err;
                    log('WARN', `Failed to connect to ${broker.name}: ${err.message}`);
                    
                    if (i < CONFIG.BROKERS.length - 1) {
                        log('INFO', `Waiting 2 seconds before trying next broker...`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            
            log('ERROR', 'All brokers failed');
            elements.startBtn.disabled = false;
            showError(
                'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„',
                'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙˆØ§Ø¯Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©',
                `Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ´Ù„Øª.\nØ¢Ø®Ø± Ø®Ø·Ø£: ${lastError?.message || 'Unknown error'}`
            );
        }
        
        function cancelConnection() {
            log('INFO', 'User canceled connection');
            stopTextSlider();
            app.reset();
            elements.startBtn.disabled = false;
            showScreen('welcome');
            updateStatus('idle');
            showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'warning');
        }
        
        function retryConnection() {
            log('INFO', 'Retrying connection...');
            startChat();
        }
        
        // ========== SEARCH AND MATCHMAKING ==========
        async function startSearch() {
            log('INFO', 'Starting search for partner...');
            
            app.state = STATES.SEARCHING;
            updateStatus('searching');
            
            elements.connectingTitle.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ...';
            elements.connectingDesc.textContent = 'Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª';
            
            // Start the text slider
            startTextSlider();
            
            subscribe(getLobbyTopic());
            subscribe(getInboxTopic(app.myId));
            
            app.helloIntervalId = setInterval(() => {
                if (app.isSearching) {
                    publish(getLobbyTopic(), {
                        type: 'HELLO',
                        from: app.myId,
                        timestamp: Date.now()
                    });
                }
            }, CONFIG.HELLO_INTERVAL);
            
            let progress = 0;
            app.progressIntervalId = setInterval(() => {
                if (!app.isSearching) {
                    clearInterval(app.progressIntervalId);
                    return;
                }
                progress = (progress + 0.5) % 100;
                elements.connectionProgress.style.width = (50 + progress/2) + '%';
            }, 50);
            
            app.connectionTimeoutId = setTimeout(() => {
                if (app.isSearching) {
                    log('WARN', 'Search timeout - no partners found');
                    elements.connectingTitle.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹';
                    elements.connectingDesc.textContent = 'Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹';
                    elements.retryCount.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ†';
                    setTimeout(() => {
                        if (app.isSearching) {
                            stopTextSlider();
                            app.reset();
                            elements.startBtn.disabled = false;
                            showScreen('welcome');
                            updateStatus('idle');
                        }
                    }, 3000);
                }
            }, CONFIG.CONNECTION_TIMEOUT);
            
            publish(getLobbyTopic(), {
                type: 'HELLO',
                from: app.myId,
                timestamp: Date.now()
            });
        }
        
        function subscribe(topic) {
            if (!app.subscriptions.has(topic) && app.client) {
                app.client.subscribe(topic, (err) => {
                    if (!err) {
                        app.subscriptions.add(topic);
                        log('INFO', 'Subscribed to: ' + topic);
                    } else {
                        log('ERROR', 'Subscribe failed to ' + topic + ': ' + err.message);
                    }
                });
            }
        }
        
        function unsubscribe(topic) {
            if (app.subscriptions.has(topic) && app.client) {
                app.client.unsubscribe(topic, (err) => {
                    if (!err) {
                        app.subscriptions.delete(topic);
                    }
                });
            }
        }
        
        function publish(topic, message) {
            if (app.client && app.client.connected) {
                try {
                    app.client.publish(topic, JSON.stringify(message));
                } catch (err) {
                    log('ERROR', 'Publish failed: ' + err.message);
                }
            }
        }
        
        // ========== MESSAGE HANDLING ==========
        async function handleMessage(topic, message) {
            try {
                const data = JSON.parse(message.toString());
                const from = data.from;
                
                if (from === app.myId) return;
                
                log('INFO', `Message from ${from.substring(0, 8)}: ${data.type}`);
                
                if (topic === getLobbyTopic() && app.isSearching) {
                    if (data.type === 'HELLO') {
                        if (from > app.myId) {
                            log('INFO', `Initiating handshake with ${from.substring(0, 8)}`);
                            await initiateHandshake(from);
                        }
                    }
                }
                
                if (topic === getInboxTopic(app.myId)) {
                    switch (data.type) {
                        case 'OFFER': await handleOffer(data); break;
                        case 'ACCEPT': await handleAccept(data); break;
                        case 'ACK': await handleAck(data); break;
                        case 'BUSY': log('INFO', 'Partner is busy'); break;
                        case 'CANCEL': handleCancel(from); break;
                    }
                }
                
                if (app.isConnected && app.roomId && topic === getRoomTopic(app.roomId)) {
                    switch (data.type) {
                        case 'MSG': addMessage(data.content, 'received', 'text'); break;
                        case 'IMAGE': addMessage(data.content, 'received', 'image'); break;
                        case 'STICKER': addMessage(data.content, 'received', 'sticker'); break;
                        case 'TYPING': showPartnerTyping(); break;
                        case 'STOP_TYPING': hidePartnerTyping(); break;
                        case 'BYE': handlePartnerLeft('ØºØ§Ø¯Ø± Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©'); break;
                    }
                }
            } catch (err) {
                log('ERROR', 'Message parse error: ' + err.message);
            }
        }
        
        // ========== MATCHMAKING PROTOCOL ==========
        async function initiateHandshake(targetId) {
            if (!app.isSearching) return;
            
            log('INFO', `Sending OFFER to ${targetId.substring(0, 8)}`);
            app.state = STATES.NEGOTIATING;
            app.partnerId = targetId;
            
            if (app.helloIntervalId) {
                clearInterval(app.helloIntervalId);
                app.helloIntervalId = null;
            }
            
            const roomId = app.generateUUID();
            publish(getInboxTopic(targetId), {
                type: 'OFFER',
                from: app.myId,
                room: roomId,
                timestamp: Date.now()
            });
            
            app.handshakeTimeoutId = setTimeout(() => {
                log('WARN', 'Handshake timeout');
                if (app.isNegotiating) {
                    publish(getInboxTopic(targetId), { type: 'CANCEL', from: app.myId });
                    cancelHandshake('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„');
                }
            }, CONFIG.HANDSHAKE_TIMEOUT);
        }
        
        async function handleOffer(data) {
            if (!app.isSearching && !app.isNegotiating) {
                publish(getInboxTopic(data.from), { type: 'BUSY', from: app.myId });
                return;
            }
            
            log('INFO', `Received OFFER from ${data.from.substring(0, 8)}`);
            
            if (app.helloIntervalId) {
                clearInterval(app.helloIntervalId);
                app.helloIntervalId = null;
            }
            
            app.state = STATES.NEGOTIATING;
            app.partnerId = data.from;
            app.roomId = data.room;
            
            publish(getInboxTopic(data.from), {
                type: 'ACCEPT',
                from: app.myId,
                room: data.room,
                timestamp: Date.now()
            });
            
            app.handshakeTimeoutId = setTimeout(() => {
                if (app.isNegotiating) {
                    publish(getInboxTopic(app.partnerId), { type: 'CANCEL', from: app.myId });
                    cancelHandshake('Ù„Ù… ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„');
                }
            }, CONFIG.HANDSHAKE_TIMEOUT);
        }
        
        async function handleAccept(data) {
            if (!app.isNegotiating || app.partnerId !== data.from) return;
            
            log('INFO', 'Received ACCEPT');
            
            clearTimeout(app.handshakeTimeoutId);
            app.handshakeTimeoutId = null;
            
            app.roomId = data.room;
            
            publish(getInboxTopic(data.from), {
                type: 'ACK',
                from: app.myId,
                room: data.room,
                timestamp: Date.now()
            });
            
            await establishConnection();
        }
        
        async function handleAck(data) {
            if (!app.isNegotiating || app.partnerId !== data.from) return;
            
            log('INFO', 'Received ACK');
            
            clearTimeout(app.handshakeTimeoutId);
            app.handshakeTimeoutId = null;
            
            app.roomId = data.room;
            await establishConnection();
        }
        
        function handleCancel(from) {
            if (app.isNegotiating && app.partnerId === from) {
                log('INFO', 'Received CANCEL from partner');
                cancelHandshake('Ø£Ù„ØºÙ‰ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
        
        async function establishConnection() {
            log('INFO', `Connected in room: ${app.roomId}`);
            
            // Stop text slider
            stopTextSlider();
            
            app.state = STATES.CONNECTED;
            
            clearTimeout(app.handshakeTimeoutId);
            app.handshakeTimeoutId = null;
            
            subscribe(getRoomTopic(app.roomId));
            
            unsubscribe(getLobbyTopic());
            unsubscribe(getInboxTopic(app.myId));
            
            if (app.helloIntervalId) {
                clearInterval(app.helloIntervalId);
                app.helloIntervalId = null;
            }
            if (app.progressIntervalId) {
                clearInterval(app.progressIntervalId);
                app.progressIntervalId = null;
            }
            
            showScreen('chat');
            hideFooter();
            elements.messagesArea.innerHTML = '';
            addSystemMessage('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„! ğŸ‘‹');
            addSystemMessage('Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! ÙƒÙŠÙ Ø­Ø§Ù„ÙƒØŸ');
            
            elements.messageInput.disabled = false;
            elements.sendBtn.disabled = false;
            elements.nextBtn.disabled = false;
            elements.messageInput.focus();
            
            updateStatus('connected');
            showToast('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø®Øµ ØºØ±ÙŠØ¨!', 'success');
        }
        
        function cancelHandshake(reason) {
            log('WARN', `Handshake cancelled: ${reason}`);
            stopTextSlider();
            app.reset();
            showScreen('welcome');
            updateStatus('idle');
            elements.startBtn.disabled = false;
        }
        
        // ========== CHAT FUNCTIONS ==========
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text || !app.isConnected) return;
            
            addMessage(text, 'sent', 'text');
            publish(getRoomTopic(app.roomId), {
                type: 'MSG',
                from: app.myId,
                content: text,
                timestamp: Date.now()
            });
            
            elements.messageInput.value = '';
            elements.messageInput.focus();
            sendStopTyping();
        }
        
        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }
        
        // ========== IMAGE SHARING ==========
        function triggerImageUpload() {
            document.getElementById('image-input').click();
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø©', 'error');
                return;
            }
            
            showToast('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...', 'warning');
            
            try {
                const compressed = await compressImage(file);
                addMessage(compressed, 'sent', 'image');
                
                if (app.isConnected) {
                    publish(getRoomTopic(app.roomId), {
                        type: 'IMAGE',
                        from: app.myId,
                        content: compressed,
                        timestamp: Date.now()
                    });
                }
                
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©', 'success');
            } catch (err) {
                log('ERROR', 'Image upload failed: ' + err.message);
                showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©', 'error');
            }
            
            event.target.value = '';
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > CONFIG.MAX_IMAGE_SIZE || height > CONFIG.MAX_IMAGE_SIZE) {
                            if (width > height) {
                                height = (height * CONFIG.MAX_IMAGE_SIZE) / width;
                                width = CONFIG.MAX_IMAGE_SIZE;
                            } else {
                                width = (width * CONFIG.MAX_IMAGE_SIZE) / height;
                                height = CONFIG.MAX_IMAGE_SIZE;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = CONFIG.IMAGE_QUALITY;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        while (dataUrl.length > CONFIG.MAX_PAYLOAD_SIZE && quality > 0.1) {
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        if (dataUrl.length > CONFIG.MAX_PAYLOAD_SIZE) {
                            reject(new Error('Image too large even after compression'));
                        } else {
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }
        
        function openImageViewer(src) {
            elements.viewerImage.src = src;
            elements.imageViewer.classList.add('active');
        }
        
        function closeImageViewer() {
            elements.imageViewer.classList.remove('active');
        }
        
        // ========== STICKERS ==========
        function toggleStickers() {
            elements.stickerPanel.classList.toggle('active');
        }
        
        function sendSticker(sticker) {
            if (!app.isConnected) return;
            
            addMessage(sticker, 'sent', 'sticker');
            publish(getRoomTopic(app.roomId), {
                type: 'STICKER',
                from: app.myId,
                content: sticker,
                timestamp: Date.now()
            });
            
            elements.stickerPanel.classList.remove('active');
        }
        
        // ========== TYPING INDICATOR ==========
        function handleTyping() {
            if (!app.isConnected) return;
            
            if (!app.isTyping) {
                app.isTyping = true;
                publish(getRoomTopic(app.roomId), { type: 'TYPING', from: app.myId });
            }
            
            if (app.typingTimeoutId) {
                clearTimeout(app.typingTimeoutId);
            }
            
            app.typingTimeoutId = setTimeout(sendStopTyping, 1000);
        }
        
        function sendStopTyping() {
            if (app.isTyping && app.isConnected) {
                app.isTyping = false;
                publish(getRoomTopic(app.roomId), { type: 'STOP_TYPING', from: app.myId });
            }
        }
        
        function showPartnerTyping() {
            elements.typingIndicator.classList.add('show');
            scrollToBottom();
        }
        
        function hidePartnerTyping() {
            elements.typingIndicator.classList.remove('show');
        }
        
        // ========== FOOTER MANAGEMENT ==========
        function hideFooter() {
            if (elements.footer) {
                elements.footer.style.display = 'none';
            }
        }
        
        function showFooter() {
            if (elements.footer) {
                elements.footer.style.display = 'flex';
            }
        }
        
        // ========== NAVIGATION ==========
        function findNewPartner() {
            log('INFO', 'Finding new partner...');
            
            if (app.isConnected && app.roomId) {
                publish(getRoomTopic(app.roomId), { type: 'BYE', from: app.myId });
            }
            
            cleanup();
            startChat();
        }
        
        function goHome() {
            cleanup();
            showFooter();
            showScreen('welcome');
            updateStatus('idle');
            elements.startBtn.disabled = false;
        }
        
        function cleanup() {
            log('INFO', 'Cleaning up...');
            stopTextSlider();
            app.reset();
            
            elements.messageInput.disabled = true;
            elements.sendBtn.disabled = true;
            elements.nextBtn.disabled = true;
            elements.typingIndicator.classList.remove('show');
            elements.stickerPanel.classList.remove('active');
        }
        
        function handlePartnerLeft(reason) {
            log('INFO', 'Partner left: ' + reason);
            
            cleanup();
            showFooter();
            
            document.getElementById('disconnect-title').textContent = reason;
            document.getElementById('disconnect-desc').textContent = 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø´Ø®Øµ Ø¢Ø®Ø±ØŸ';
            showScreen('disconnected');
            showToast(reason, 'warning');
        }
        
        // ========== EVENT LISTENERS ==========
        elements.messageInput.addEventListener('input', handleTyping);
        
        window.addEventListener('beforeunload', () => {
            if (app.isConnected && app.roomId) {
                try {
                    navigator.sendBeacon(getRoomTopic(app.roomId), JSON.stringify({ type: 'BYE', from: app.myId }));
                } catch(e) {}
            }
            app.isIntentionallyClosing = true;
            if (app.client) {
                try { app.client.end(); } catch(e) {}
            }
        });
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if ((app.isConnected || app.isSearching) && (!app.client || !app.client.connected)) {
                    log('INFO', 'Tab became visible, reconnecting...');
                    if (app.isConnected) {
                        handlePartnerLeft('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
                    } else {
                        startChat();
                    }
                }
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && elements.aboutModal && elements.aboutModal.classList.contains('active')) {
                closeAboutModal();
            }
        });
        
        // ========== START ==========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
